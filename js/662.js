(self.webpackChunkmp_webgl=self.webpackChunkmp_webgl||[]).push([[662],{61282:(e,t,i)=>{"use strict";i.d(t,{N2:()=>l,O8:()=>p,SI:()=>a,TD:()=>m,bC:()=>v,bp:()=>d,jX:()=>u,mP:()=>c,pj:()=>n,qj:()=>h,uQ:()=>o,v0:()=>g,zf:()=>r});var s=i(69505);const a=1e3/60,o=89*s.Ue,n=90*s.Ue,r=.001*s.Ue,d=10*s.Ue,l=20*s.Ue,h=.25,c=500,u=.1,m=.16,p=.08,g=Math.PI/1e3,v=.02},10840:(e,t,i)=>{"use strict";i.d(t,{T:()=>g});var s=i(81396),a=i(11677),o=i(44724),n=i.n(o),r=i(7188),d=i.n(r),l=i(52059),h=i.n(l),c=i(75215),u=i.n(c),m=i(56449),p=i.n(m);const g={endpoint:{uniforms:{opacity:{type:"f",value:1},color:{type:"c",value:new s.Color},bg:{type:"t",value:null}},vertexShader:a.Z.basicTextured.vertexShader,fragmentShader:n()},line:{uniforms:s.UniformsUtils.merge([s.UniformsLib.common,s.UniformsLib.fog,{linewidth:{value:4},resolution:{value:new s.Vector2(0,0)},dashScale:{value:1},dashSize:{value:.025},gapSize:{value:.05},mask:{value:null}}]),vertexShader:d(),fragmentShader:h()},screenline:{uniforms:{lineWidth:{value:1},screenSize:{value:new s.Vector2(0,0)},dashed:{value:0},dashSize:{value:1},gapSize:{value:1},antialiasWidth:{value:1},color:{value:new s.Color(1,0,0)},opacity:{value:1},start:{value:new s.Vector3},end:{value:new s.Vector3}},vertexShader:u(),fragmentShader:p()}}},72119:(e,t,i)=>{"use strict";i.d(t,{E0:()=>n,Hn:()=>c,NZ:()=>o,Nz:()=>m,Oq:()=>h,Ql:()=>u,X7:()=>d,ox:()=>r,xh:()=>l,yV:()=>a});var s=i(83402);const a=.01,o=.001,n=!0,r={highResThreshold:1081,desktopSize:192,desktopSizeHighRes:320,mobileSize:128},d={smoothness:.4,perspective:{fov:40,thresholdClose:1,thresholdFar:8,offsetClose:.25,offsetFar:.5,scale:1},ortho:{fov:5,thresholdClose:5,thresholdFar:20,offsetClose:15,offsetFar:30,scale:4}},l={desktop:s.l1.Edges,floorplan:s.l1.Axes,mobile:s.l1.Edges,alt:s.l1.Free,shift:s.l1.PlanarAxes,shiftAlt:s.l1.EdgesAndPlanarAxes,disabled:s.l1.Free},h={mobile:.15,desktop:.1},c={SCALE:.1,SCALE_NDC:.5,SCALE_ASPECT:.035,SCALE_DISTANCE:.025},u="measurements",m=24},38987:(e,t,i)=>{"use strict";i.d(t,{u:()=>a});var s=i(19663);class a extends s.m{constructor(e=null){super(),this.id="SET_MOUSE_CURSOR",this.payload={cursor:e}}}},34956:(e,t,i)=>{"use strict";var s;i.d(t,{C:()=>s}),function(e){e.NONE="none",e.DEFAULT="default",e.MOVE="move",e.MOVE_LF="col-resize",e.MOVE_UD="row-resize",e.XHAIR="crosshair",e.PLUS="cell",e.QUESTION="help",e.NOPE="not-allowed",e.FINGER="pointer",e.TEXT="text",e.TEXT_VERT="vertical-text",e.ZOOM_IN="zoom-in",e.ZOOM_OUT="zoom-in",e.GRAB="grab",e.GRABBING="grabbing",e.ARROW_R="e-resize",e.ARROW_L="w-resize",e.ARROW_U="n-resize",e.ARROW_D="s-resize",e.ARROW_UR="ne-resize",e.ARROW_UL="nw-resize",e.ARROW_DR="se-resize",e.ARROW_DL="sw-resize",e.ARROW_LR="ew-resize",e.ARROW_UD="ns-resize",e.ARROW_URDL="nesw-resize",e.ARROW_ULDR="nwse-resize",e.ROOMBOUNDS_DEFAULT="rbe-default",e.ROOMBOUNDS_MOVING="rbe-moving",e.ROOMBOUNDS_PLACE_NODE="rbe-place-node",e.ROOMBOUNDS_FINISH_ROOM="rbe-finish-room"}(s||(s={}))},39564:(e,t,i)=>{"use strict";i.d(t,{t:()=>o});var s=i(67992),a=i(15637);class o extends s.V{constructor(e){super(),this.name="notes-data",this.notes=(0,a.q)(e)}iterate(e){for(const t of this.notes)e(t)}updateNote(e){this.notes.has(e.id)?this.notes.get(e.id).copy(e):this.notes.set(e.id,e)}updateNoteProperties(e,t){if(this.notes.has(e)){const i=this.notes.get(e);let s=!1;void 0!==t.resolved&&t.resolved!==i.resolved&&(i.resolved=t.resolved,s=!0),void 0!==t.color&&t.color!==i.color&&(i.color=t.color,s=!0),void 0!==t.anchorPosition&&t.anchorPosition!==i.anchorPosition&&(i.anchorPosition=t.anchorPosition,s=!0),void 0!==t.stemNormal&&t.stemNormal!==i.stemNormal&&(i.stemNormal=t.stemNormal,s=!0),void 0!==t.stemLength&&t.stemLength!==i.stemLength&&(i.stemLength=t.stemLength,s=!0),void 0!==t.stemEnabled&&t.stemEnabled!==i.stemEnabled&&(i.stemEnabled=t.stemEnabled,s=!0),void 0!==t.floorId&&t.floorId!==i.floorId&&(i.floorId=t.floorId,s=!0),void 0!==t.roomId&&t.roomId!==i.roomId&&(i.roomId=t.roomId,s=!0),s&&i.commit()}}removeNote(e){this.notes.has(e)&&(this.notes.delete(e),this.commit())}getNote(e){return this.notes.get(e)}getNoteProperties(e){const t=this.notes.get(e);if(!t)return null;return Object.assign({},t)}get collection(){return this.notes}}},72957:(e,t,i)=>{"use strict";i.r(t),i.d(t,{default:()=>X});var s=i(97542),a=i(89570),o=i(92810),n=i(35221),r=i(5823),d=i(80742),l=i(34029),h=i(26158),c=i(46391),u=i(54244),m=i(47309),p=i(63422),g=i(38399),v=i(71166),f=i(56163),w=i(76957),y=i(12039),S=i(15004),b=i(84784);class E extends f.K{constructor(e,t,i,s,a,o,d){super(e,t,s),this.room=a,this.title=o,this.id=this.room.id,this.icon=`icon-${(0,S.mX)(this.room.roomTypeIds)}`,this.typeId=r.SF.MODELROOM,this.layerId=p.gi,this.dateBucket=n.Z.OLDER,this.enabled=!0,this.onSelect=async()=>{super.onSelect(),await this.commandBinder.issueCommand(new y.SG(this.room))},this.floorId=d,this.roomId=a.id;const l=i.tryGetProperty(h.F.UnitType,c.M.IMPERIAL);this.description=this.room.getMeasurementText(l)}}var D=i(51043),I=i(41999),A=i(39011),C=i(17788),O=i(22999),R=i(97998),M=i(78283);const V=new R.Z("MdsRoomBoundsDeserializer");class T{deserialize(e){var t,i,s,a,o,n,r,d,l,h,c,u,m,g,v;const f={version:0,floors:{}};for(const r of e.floors||[]){const e={edges:{},vertices:{},rooms:{}};f.floors[r.id]=e;for(const s of r.vertices||[])s?e.vertices[s.id]={x:s.position.x,y:s.position.y,layerId:null!==(i=null===(t=s.layer)||void 0===t?void 0:t.id)&&void 0!==i?i:p.gi}:V.warn("Found null vertex in floor vertices!");for(const t of r.edges||[]){if(!t||null===t.thickness||null===t.centerLineBias||null===t.vertices||2!==t.vertices.length){V.warn("Invalid edge!");continue}const i={vertices:t.vertices.map((e=>e.id)),thickness:t.thickness,bias:t.centerLineBias,openings:{},type:t.type||void 0,layerId:null!==(a=null===(s=t.layer)||void 0===s?void 0:s.id)&&void 0!==a?a:p.gi};e.edges[t.id]=i;for(const e of t.openings||[]){if(!e){V.warn("Found null opening!");continue}const t={height:e.height,lowerElevation:e.lowerElevation,relativePos:e.relativeCenter,type:e.type,width:e.width,layerId:null!==(n=null===(o=e.layer)||void 0===o?void 0:o.id)&&void 0!==n?n:p.gi};i.openings[e.id]=t}}}for(const t of e.rooms||[]){if(!t||!t.floor){V.warn("Found null room");continue}if(!f.floors[t.floor.id]){V.warn("Unable to find floor for room!");continue}const e=t.classifications||[].sort(((e,t)=>(e.confidence||0)-(t.confidence||0))),i=null===(r=t.dimensionEstimates)||void 0===r?void 0:r.units,s=(t.label||"").trim();f.floors[t.floor.id].rooms[t.id]={height:.1,edges:(null===(l=null===(d=t.boundary)||void 0===d?void 0:d.edges)||void 0===l?void 0:l.map((e=>e.id)))||[],holes:(null===(h=t.holes)||void 0===h?void 0:h.map((e=>{var t;return(null===(t=e.edges)||void 0===t?void 0:t.map((e=>e.id)))||[]})))||[],classifications:e,label:s,width:this.ensureMetric("distance",null===(c=t.dimensionEstimates)||void 0===c?void 0:c.width,i),length:this.ensureMetric("distance",null===(u=t.dimensionEstimates)||void 0===u?void 0:u.depth,i),area:this.ensureMetric("area",null===(m=t.dimensionEstimates)||void 0===m?void 0:m.area,i),layerId:null!==(v=null===(g=t.layer)||void 0===g?void 0:g.id)&&void 0!==v?v:p.gi,keywords:t.keywords||[]}}return f}ensureMetric(e,t,i){if(null!=t&&null!=i){const s=i===r.nL.IMPERIAL,a="area"===e?M.W3:M._F;return s?a(t):t}return NaN}}var x=i(16747);const N=new R.Z("MdsRoomBoundsStore");class L extends C.u{constructor(e){super(e),this.queuedMutations=[],this.seenRooms=new Map,this.lastUpdates=new Map,this.deserializer=new T}async read(e){var t,i;const s={modelId:this.getViewId()},a=await this.query(O.GetRoomBounds,s,e);return(null===(i=null===(t=null==a?void 0:a.data)||void 0===t?void 0:t.model)||void 0===i?void 0:i.floors)?this.deserializer.deserialize(a.data.model):null}async readClassifications({options:e,localizeFn:t}={}){var i;return((null===(i=(await this.query(O.GetRoomClassifications,{},e)).data)||void 0===i?void 0:i.roomClassifications)||[]).reduce(((e,i)=>(i&&(e[i.id]=t?t(i):i),e)),{})}setReadOnly(e){this.config.readonly=e}queueRemoveEntity(e,t,i){this.queueDeleteRoomsAndBoundaryData(e,t,i)}queueAddNode(e){this.queuedMutations.push(`addBoundaryVertex(modelId: $modelId, id: "${e.id}", vertex: ${this.vertexDetailsFromNode(e)}) { id }`)}queueUpdateNode(e){this.updateEntity("node",e.id,`patchBoundaryVertex(modelId: $modelId, id: "${e.id}", vertex: ${this.vertexDetailsFromNode(e)}) { id }`)}vertexDetailsFromNode(e){return`{\n      floorId: "${e.floorId}",\n      position: { x: ${e.x} y: ${-e.z} }\n      ${this.layerId(e.layerId)}\n    }`}queueRemoveNode(e){this.queueRemoveEntity("node",e.id,e.layerId)}queueAddWall(e){this.queuedMutations.push(`addBoundaryEdge(modelId: $modelId, id: "${e.id}", edge: ${this.edgeDetailsFromWall(e)}) { id }`)}queueUpdateWall(e){this.updateEntity("wall",e.id,`patchBoundaryEdge(modelId: $modelId, id: "${e.id}" edge: ${this.edgeDetailsFromWall(e)}) { id }`)}edgeDetailsFromWall(e){return`\n    {\n      floorId: "${e.floorId}" \n      vertices: ["${e.from.id}", "${e.to.id}"]\n      thickness: ${e.width} \n      units: ${r.nL.METRIC} \n      centerLineBias: ${1-e.bias}\n      type: ${e.type===x.d.SOLID?r.Pb.WALL:r.Pb.INVISIBLE}\n      ${this.layerId(e.layerId)}\n    }\n    `}queueRemoveWall(e){this.queueRemoveEntity("wall",e.id,e.layerId)}queueAddOpening(e){this.queuedMutations.push(`addEdgeOpenings(modelId: $modelId, id: "${e.wallId}", openings: [${this.openingDetailsFromOpening(e)}]) { id }`)}queueUpdateOpening(e){this.updateEntity("opening",e.id,`patchEdgeOpening(modelId: $modelId, id: "${e.wallId}", opening: ${this.openingDetailsFromOpening(e)}) { id }`)}openingDetailsFromOpening(e){return`\n    {\n      id: "${e.id}" \n      relativeCenter: ${e.relativePos} \n      type: ${e.type} \n      width: ${e.width} \n      ${this.layerId(e.layerId)}\n      height: 0.1, \n      lowerElevation: 0.1\n    }\n    `}queueRemoveOpening(e){this.queuedMutations.push(`removeEdgeOpenings(\n        modelId: $modelId\n        id: "${e.wallId}"\n        openings: ["${e.id}"]\n        layerId: "${e.layerId}"\n      )`),this.clearEntityUpdate("opening",e.id)}queueAddRoom(e){this.queuedMutations.push(`addRoom(\n        modelId: $modelId,\n        id: "${e.id}",\n        room: ${this.getRoomDetailsFromRoom(e)}\n      ) { id }`)}queueUpdateRoom(e){const t=this.seenRooms.get(e.id);t&&t!==e&&this.clearEntityUpdate("room",e.id),this.seenRooms.set(e.id,e),this.updateEntity("room",e.id,`patchRoom(\n        modelId: $modelId,\n        id: "${e.id}",\n        room: ${this.getRoomDetailsFromRoom(e)}\n      ) { id }`)}getRoomDetailsFromRoom(e){return`\n    {\n      floorId: "${e.floorId}"\n      label: "${this.escapeUserString(e.name)}"\n      classifications: [${e.roomTypeIds.map((e=>`"${e}"`))}],\n      ${this.layerId(e.layerId)}\n      boundary: {\n        edges: [${Array.from(e.walls.values()).map((e=>`"${e.id}"`))}],\n      }\n      holes: [${Array.from(e.holes.values()).map((e=>`{ edges: [${Array.from(e.values()).map((e=>`"${e.id}"`))}] }`))}]\n      dimensionEstimates: {\n        room: "${e.id}",\n        area: ${Number.isNaN(e.area)?null:e.area},\n        areaIndoor: ${Number.isNaN(e.area)?null:e.area},\n        depth: ${Number.isNaN(e.length)?null:e.length}\n        width: ${Number.isNaN(e.width)?null:e.width}\n        units: ${r.nL.METRIC}\n      }\n      keywords: [${e.allKeywords().map((e=>`"${e}"`))}]\n    }\n    `}queueRemoveRoom(e){this.seenRooms.delete(e.id),this.queueRemoveEntity("room",e.id,e.layerId)}queueRemoveLegacyRooms(e){const t=e.map((e=>`"${e}"`));this.queuedMutations.push(`deleteRoomsAndBoundaryData(\n      modelId: $modelId,\n      selectedData: {\n        ids: [${t.join(",")}],\n        type: ${r.TS.ROOM}\n      }\n    )`)}queueUpdateRoomAssociations(e){if(0===e.length)return;this.queuedMutations.push(`bulkPatchRoomData(\n        modelId: $modelId,\n        updatedRoomAssociations: [${e.map((e=>(e=>`{ ${Object.keys(e).map((t=>`${t}: ${JSON.stringify(e[t])}`)).join(",")} }`)(e)))}]\n      )`)}async submitQueuedMutations(){if(0===this.queuedMutations.length)return;const e=I.gql`
      mutation updateRoomBoundaries($modelId: ID!) {
        ${this.queuedMutations.map(((e,t)=>`op${t}: ${e}`)).join("\n")}
      }
    `;this.queuedMutations.length=0;for(const e of this.lastUpdates.values())e.clear();N.debug((0,A.S)(e)),await this.mutate(e,{modelId:this.getViewId()}),N.debug("mutation successful")}clearQueuedMutations(){this.queuedMutations.length=0;for(const e of this.lastUpdates.values())e.clear()}updateEntity(e,t,i){const s=this.lastUpdates.get(e)||new Map;this.lastUpdates.set(e,s);const a=s.get(t);void 0!==a?this.queuedMutations[a]=i:(this.queuedMutations.push(i),s.set(t,this.queuedMutations.length-1))}clearEntityUpdate(e,t){const i=this.lastUpdates.get(e);i&&i.delete(t)}queueDeleteRoomsAndBoundaryData(e,t,i){let s=r.TS.BOUNDARYVERTEX;switch(e){case"room":s=r.TS.ROOM;break;case"wall":s=r.TS.BOUNDARYEDGE}this.queuedMutations.push(`deleteRoomsAndBoundaryData(\n        modelId: $modelId,\n        selectedData: {\n          ids: ["${t}"],\n          type: ${s},\n          ${this.layerId(i)}\n        }\n      )`),this.clearEntityUpdate(e,t)}layerId(e){return e!==p.gi?`layerId: "${e}"`:""}escapeUserString(e){return e.replace(/\\/g,"\\\\").replace(/"/g,'\\"')}}var P=i(80008),F=i(85679),k=i(39564),B=i(92294),W=i(59512),U=i(53954),z=i(39693),_=i(96776),H=i(75668),G=i(32683),j=i(28269),$=i(20241),q=i(635),Y=i(79728),Z=i(10374);class K extends s.Y{constructor(){super(...arguments),this.name="room_bound_data",this.associationSources=[],this.modifiedFloors=new Set,this.afterFinalize=async()=>{if(!this.writeBindings)throw new Error("Not permitted to write room bounds data");try{this.store.queueUpdateRoomAssociations(this.updateRoomAssociations()),await this.store.submitQueuedMutations()}catch(e){this.log.info("Error finalizing room bounds data",e),this.data.clearUndoBuffer();const t=await this.store.read();throw this.writeBindings.cancel(),this.data.load(t||{version:0,floors:{}}),this.data.commit(),this.writeBindings.renew(),e}},this.addRoom=e=>{this.roomData.get(e.id)||this.roomData.add(new $.d({id:e.id,floorId:e.floorId,meshSubgroup:-1})),this.addToModifiedFloors(e),this.data.legacyRoomIds.length&&(this.store.queueRemoveLegacyRooms(this.data.legacyRoomIds),this.data.legacyRoomIds.forEach((e=>this.roomData.remove(e))),this.data.legacyRoomIds.length=0),this.store.queueAddRoom(e)},this.removeRoom=e=>{this.roomData.get(e.id)&&this.roomData.remove(e.id),this.addToModifiedFloors(e),this.store.queueRemoveRoom(e)}}async init(e,t){const[i,s,n]=await Promise.all([t.market.waitForData(d.R),t.market.waitForData(j.Z),t.market.waitForData(u.pu)]);this.roomData=s,this.layersData=i,this.issueCommand=t.commandBinder.issueCommand;const c=i.getBaseModelView();if(!c)throw new Error("Unable to find view for RoomBound data");this.localeModule=await t.getModuleBySymbol(o.e9),this.store=new L({viewId:c.id,context:i.mdsContext,readonly:e.readonly,baseUrl:e.baseUrl});let p=await this.store.read();p&&!e.readonly&&(p=this.validateData(p));const f=await this.store.readClassifications({localizeFn:e=>this.localizeRoomClassification(e)});H.Ds.forEach((e=>{const t=e.join(H.Rt);f[t]={id:t,label:e.map((e=>f[e].label)).join(H.X9),defaultKeywords:(0,G.Hc)(e.map((e=>f[e])))}})),this.data=new D.Z(p,f,t.broadcast.bind(t)),this.data.commit(),this.data.clearUndoBuffer(),this.data.resetHistory(),e.readonly||(this.writeBindings=new a.V(this.data.onWallsChanged({onAdded:e=>{this.addToModifiedFloors(e),this.store.queueAddWall(e)},onUpdated:e=>{this.addToModifiedFloors(e),this.store.queueUpdateWall(e)},onRemoved:e=>{this.addToModifiedFloors(e),this.store.queueRemoveWall(e)}}),this.data.onNodesChanged({onAdded:e=>{this.addToModifiedFloors(e),this.store.queueAddNode(e)},onUpdated:e=>{this.addToModifiedFloors(e),this.store.queueUpdateNode(e)},onRemoved:e=>{this.addToModifiedFloors(e),this.store.queueRemoveNode(e)}}),this.data.onRoomsChanged({onAdded:this.addRoom,onUpdated:e=>{this.addToModifiedFloors(e),this.store.queueUpdateRoom(e)},onRemoved:this.removeRoom}),this.data.onOpeningsChanged({onAdded:e=>{this.addToModifiedFloors(e),this.store.queueAddOpening(e)},onUpdated:e=>{this.addToModifiedFloors(e),this.store.queueUpdateOpening(e)},onRemoved:e=>{this.addToModifiedFloors(e),this.store.queueRemoveOpening(e)}}),this.data.afterFinalize((async()=>{await t.commandBinder.issueCommand(new q.V({dataTypes:[Y.g.ROOM_BOUNDS],onCallback:this.afterFinalize,skipDirtyUpdate:!0}))}))),this.writeBindings.cancel()),await this.updateForApp(t,n.application),this.bindings.push(t.subscribe(Z.bS,(e=>this.updateForApp(t,e.application)))),await this.registerRoomAssociationSources(t),this.store.clearQueuedMutations(),async function(e,t){const[i,s,n,c,p]=await Promise.all([e.market.waitForData(u.pu),e.market.waitForData(d.R),e.market.waitForData(l.e),e.market.waitForData(w.i),e.getModuleBySymbol(o.e9)]);let f=i.application===u.Mx.WORKSHOP;const y=(i,a,o,r=[])=>{if(!f&&!n.tryGetProperty(m.hW,!1))return[];if(r.length>0)return[];const d=[];for(const o of t.rooms.values()){const r=(0,b.LN)(o.id,p,t);if(i(o.name)||i(r)){const t=c.getFloor(o.floorId);if(!t)throw new Error("Unable to find floor for room while generating search results.");d.push(new E(e.commandBinder,s,n,a,o,r,t.id))}}return d.sort(((e,t)=>e.title.localeCompare(t.title)))},S=e=>{},D=e=>new a.V(t.onChanged(e),n.onPropertyChanged(h.F.UnitType,e)),I={renew:()=>{e.commandBinder.issueCommandWhenBound(new v.c6({id:r.SF.MODELROOM,groupPhraseKey:g.Z.SHOWCASE.ROOMS.SEARCH_GROUP_HEADER,getSimpleMatches:y,registerChangeObserver:D,onSearchActivatedChanged:S,groupOrder:100,groupIcon:"edit-floorplan",batchSupported:!1}))},cancel:()=>{e.commandBinder.issueCommandWhenBound(new v.Pe(r.SF.MODELROOM))}},A=()=>{f=i.application===u.Mx.WORKSHOP,n.tryGetProperty(m.hW,!1)||f?I.renew():I.cancel()},C=i.onPropertyChanged("application",A),O=n.onPropertyChanged(m.hW,A);return A(),new a.V(I,C,O)}(t,this.data).then((e=>this.bindings.push(e))),t.market.register(this,D.Z,this.data)}dispose(e){super.dispose(e),this.writeBindings&&this.writeBindings.cancel()}localizeRoomClassification(e){return this.localeModule?Object.assign(Object.assign({},e),{label:(0,b.Nw)(e,this.localeModule)}):e}validateData(e){return Object.values(e.floors).forEach((e=>{const t={};Object.values(e.edges).forEach((e=>{e.vertices&&e.vertices.forEach((e=>{t[e]=!0}))}));const i={};Object.entries(e.vertices).forEach((([e,s])=>{t[e]?i[e]=s:this.store.queueRemoveEntity("node",e,s.layerId)})),e.vertices=i})),this.store.submitQueuedMutations(),e}trackRoomBoundsABTest(e,t){Promise.all([e.getModuleBySymbol(o.V6),e.market.waitForData(l.e)]).then((([e,i])=>{const s=this.data.rooms.size>0,a=t===u.Mx.WORKSHOP||s&&(0,m.G)(i);e.trackFeatures(`${m.A0}:${a}`)}))}async updateForApp(e,t){this.trackRoomBoundsABTest(e,t);const i=t===u.Mx.SHOWCASE;if(this.store.setReadOnly(i),this.writeBindings)if(i)this.writeBindings.cancel();else{this.writeBindings.renew(),await this.issueCommand(new P.fk);const e=this.layersData.getViewLayerIdForBaseView();if(!e)throw Error("Cannot edit rooms without base view view-data layer");this.data.defaultLayerId=e,this.data.validateGraph()}}addToModifiedFloors(e){this.modifiedFloors.add(e.floorId)}updateRoomAssociations(){const e=new Map;for(const t of this.associationSources)for(const i of t.getPositionId()){if(!i.floorId||!this.modifiedFloors.has(i.floorId))continue;const s=this.data.findRoomIdForPosition(i.position,i.floorId,i.roomId);if(s!=i.roomId){const a=e.get(s)||(s?{roomId:s}:{resetRoom:!0}),o=a[t.type]||[];o.push(i.id),a[t.type]=o,e.set(s,a),t.updateRoomForId(i.id,s)}}return this.modifiedFloors.clear(),Array.from(e.values())}async registerRoomAssociationSources(e){const t=await e.market.waitForData(l.e),i=await e.market.waitForData(F.n);if(this.associationSources.push({type:"mattertags",getPositionId:function*(){for(const e of i)yield{id:e.sid,roomId:e.roomId,floorId:e.floorId,position:e.anchorPosition}},updateRoomForId:(e,t)=>{const s=i.getTag(e);if(!s)throw new Error("Invalid tag id!");s.roomId=t||void 0}}),t.tryGetProperty(z.Mp,!1)){const t=await e.market.waitForData(k.t);this.associationSources.push({type:"notes",getPositionId:function*(){for(const e of t.collection.values)yield{id:e.id,roomId:e.roomId,floorId:e.floorId,position:e.anchorPosition}},updateRoomForId:(e,i)=>{const s=t.getNote(e);if(!s)throw new Error("Invalid note id!");s.roomId=i||void 0}})}const s=await e.market.waitForData(B.X);if(this.associationSources.push({type:"measurements",getPositionId:function*(){for(const e of s.groups())yield{id:e.info.sid,roomId:e.info.roomId,floorId:e.info.floorId,position:e.get(0)}},updateRoomForId:(e,t)=>{const i=s.getGroupInfoBySid(e);if(!i)throw new Error("Invalid measurement group id");i.info.roomId=t||void 0}}),t.tryGetProperty(_.QA,!1)){const t=await e.market.waitForData(W.h);this.associationSources.push({type:"objectAnnotations",getPositionId:function*(){for(const e of t.collection.values)yield{id:e.id,roomId:e.roomId,floorId:e.floorId,position:e.position}},updateRoomForId:(e,i)=>{const s=t.getObjectTag(e);if(!s)throw new Error("Invalid object detection id!");s.roomId=i||void 0}})}const a=await e.market.waitForData(U.Z);this.associationSources.push({type:"locations",getPositionId:function*(){for(const e of a.sweeps())yield{id:e.id,roomId:e.roomId||void 0,floorId:e.floorId||void 0,position:e.position}},updateRoomForId:(e,t)=>{const i=a.getSweep(e);if(!i)throw new Error("Invalid sweep id!");i.roomId=t||null}})}}const X=K},87240:(e,t,i)=>{"use strict";i.r(t),i.d(t,{default:()=>Si});var s=i(92810),a=i(97542),o=i(34029),n=i(60975),r=i(6282),d=i(76631),l=i(91380),h=i(50892),c=i(89549),u=i(59625),m=i(71776),p=i(38987),g=i(34956),v=i(39693),f=i(43736),w=i(92001),y=i(65019),S=i(41326),b=i(66917),E=i(10513),D=i(51043),I=i(47309),A=i(38127),C=i(90304),O=i(16747),R=i(2482),M=i(55248),V=i(81396),T=i(59370),x=i(2569);var N;!function(e){e[e.NONE=0]="NONE",e[e.LINE=1]="LINE",e[e.POINT=2]="POINT"}(N||(N={}));const L=(()=>{const e=new V.Vector2,t={target:new V.Vector3,closestLine:new V.Line3,orthoLine:new V.Line3,targetType:N.NONE};return(i,s,a,o)=>{t.target.copy(o),t.targetType=N.NONE;let n=Number.MIN_VALUE;const r=P(i,a);for(const e of r){const{dist:i,weight:a,closestPt:r}=k(e,o,s);i<15&&a>n&&(n=a,t.target.copy(r),t.closestLine.copy(e),t.targetType=N.LINE)}if(t.targetType===N.LINE){let n=Number.MIN_VALUE;const r=P(i,a);for(const i of r)if(B(i,t.closestLine)){const{dist:a,weight:r}=k(i,o,s);if(a<7.5&&r>n){(0,x.cB)(i.start.x,i.start.z,i.end.x,i.end.z,t.closestLine.start.x,t.closestLine.start.z,t.closestLine.end.x,t.closestLine.end.z,e)&&(n=r,t.target.set(e.x,0,e.y),t.orthoLine.copy(i),t.targetType=N.POINT)}}}return t}})(),P=(()=>{const e=new V.Line3(new V.Vector3,new V.Vector3),t=new V.Vector3,i=new V.Vector3,s=new V.Vector3,a=new V.Vector3(0,1,0);return function*(o,n){const r=o.getWallsForNode(n),d=o.getWallsForFloor(n.floorId);if(d)for(const o of d)if(!r.has(o)){const n=o.from.getVec3(t),r=o.to.getVec3(i);e.set(n,r),yield e,s.subVectors(r,n).normalize(),s.applyAxisAngle(a,Math.PI/2);const d=i.addVectors(n,s);e.set(n,d),yield e;const l=o.to.getVec3(t),h=i.addVectors(l,s);e.set(l,h),yield e}}})(),F=(()=>{const e=new V.Vector2,t=new V.Vector2,i=new V.Vector3;return(s,a,o)=>{const n=(0,T.q9)(s,a,e,i).screenPosition,r=(0,T.q9)(s,o,t,i).screenPosition;return n.distanceTo(r)}})(),k=(()=>{const e={dist:0,weight:0,closestPt:new V.Vector3};return(t,i,s)=>{const a=t.closestPointToPoint(i,!1,e.closestPt),o=F(s,a,i);e.dist=o;const n=F(s,t.start,a);return e.weight=Math.max(5-.0025*n,0),e}})(),B=(()=>{const e=new V.Vector3,t=new V.Vector3;return(i,s)=>(e.subVectors(i.end,i.start).normalize(),t.subVectors(s.end,s.start).normalize(),Math.abs(e.dot(t))<.1)})();var W=i(32597),U=i(80978),z=i(32683),_=i(66957),H=i(78596);class G{constructor(e,t,i,s,a,o){this.editor=e,this.getCursorOrigin=t,this.data=i,this.cameraData=s,this.snappingAxesRenderer=a,this.keyboardState=o,this.readBindings=[],this.writeBindings=[],this.edgeStateOnDragStart={fromOffset:new V.Vector3,toOffset:new V.Vector3,initialGrabPt:new V.Vector3,dragDir:new V.Vector3,fromDirection:new V.Vector3,toDirection:new V.Vector3},this.openingStateOnDragStart={relativeStart:0,relativeEnd:0,wallLine:new V.Line3},this.onMoveStart=({target:e,placeOnly:t})=>{if(e&&t){const t=this.data.getEntity(e);t instanceof O.c?this.onWallMoveStart(t):t instanceof U.E&&this.onWallOpeningMoveStart(t)}},this.mover={onMove:(e,t)=>{const{data:i,editor:s}=this;if(!s.state.currentId)return;const a=s.state.toolState===E.M.ToolState.ADDING?i.getWall(s.state.currentId).to:i.getEntity(s.state.currentId),o=this.getCursorOrigin();a instanceof R.z?this.onMoveNode(a,o):a instanceof O.c?this.onMoveWall(a,o):a instanceof U.E&&this.onMoveWallOpening(a,o)}},this.mergePointAndStartNewWall=({target:e})=>{const{editor:t}=this;if(t.state.toolState===E.M.ToolState.ADDING&&e){const t=this.data.getWall(e).to.id,i=this.data.getNode(t),s=i.getVec3(),a=this.data.findNodeOrWallForPosition(s,i.floorId,this.data.getAttachedEntities(i)),o=this.checkForNodeOrWallHit(t);if(this.data.finalizeHistory(),o||a)this.editor.discard(),this.editor.select(t),this.snappingAxesRenderer.hide();else{const{wall:e}=this.data.addTrailingEdgeToNode(this.editor.state.wallType,t,this.getCursorOrigin(),this.data.getLastWallWidth(this.editor.state.wallType));this.editor.add(e)}}},this.finalizeMovePt=({target:e})=>{if(e){const t=this.data.getEntity(e);(t instanceof O.c||t instanceof R.z)&&this.mergeOverlapsOnMoveEnd(t),this.data.finalizeHistory(),this.snappingAxesRenderer.hide()}},this.killLastWall=({target:e})=>{const{data:t,editor:i}=this;i.state.toolState===E.M.ToolState.ADDING&&(this.clearHighlightedViews(),e&&this.data.undo(),t.finalizeHistory(),this.snappingAxesRenderer.hide())},this.onHoverChange=({target:e,previous:t})=>{if(this.editor.state.toolState===E.M.ToolState.ADDING)return;if(!e)return this.editor.clearAllDims(),this.editor.clearAllHighlights(),void(this.editor.state.selected&&this.setSelectedView(this.editor.state.selected));const i=this.data.getEntity(e);this.hoverView(i)},this.onCurrentChange=({target:e})=>{this.editor.state.toolState!==E.M.ToolState.ADDING&&this.clearHighlightedViews(),this.highlightView(e)},this.onSelectChange=({target:e})=>{this.setSelectedView(e)},this.editableEntities=new M.C.EditorEntityAdapter(this.editor),this.editor.setValidator(this)}addEditableEntity(e,t){this.editableEntities.registerEntity(t,this,e)}removeEditableEntity(e){this.editableEntities.unregisterEntity(e)}activate(e){0===this.readBindings.length?this.readBindings.push(this.editor.subscribe(E.M.Events.CurrentChange,this.onCurrentChange),this.editor.subscribe(E.M.Events.SelectChange,this.onSelectChange),this.editor.subscribe(E.M.Events.HoverChange,this.onHoverChange)):this.readBindings.forEach((e=>e.renew())),e||(0===this.writeBindings.length?this.writeBindings.push(this.editor.subscribe(E.M.Events.EditStart,this.onMoveStart),this.editor.subscribe(E.M.Events.AddConfirm,this.mergePointAndStartNewWall),this.editor.subscribe(E.M.Events.EditConfirm,this.finalizeMovePt),this.editor.subscribe(E.M.Events.AddDiscard,this.killLastWall)):this.writeBindings.forEach((e=>e.renew())))}deactivate(){this.readBindings.forEach((e=>e.cancel())),this.writeBindings.forEach((e=>e.cancel()))}onWallMoveStart(e){const t=this.getCursorOrigin();e.from.getVec3(this.edgeStateOnDragStart.fromOffset),e.to.getVec3(this.edgeStateOnDragStart.toOffset),this.edgeStateOnDragStart.fromOffset.sub(t),this.edgeStateOnDragStart.toOffset.sub(t),this.edgeStateOnDragStart.initialGrabPt.copy(t),e.getDirection(this.edgeStateOnDragStart.dragDir),this.edgeStateOnDragStart.dragDir.normalize(),this.edgeStateOnDragStart.dragDir.applyAxisAngle(new V.Vector3(0,1,0),Math.PI/2);const i=this.edgeStateOnDragStart.dragDir,s=this.needsWallJoint(e,e.from,i),a=this.needsWallJoint(e,e.to,i);(s||a)&&this.data.addWallJoint(e.id,s?e.from.id:void 0,a?e.to.id:void 0),this.getWallDirection(e,e.from,i,this.edgeStateOnDragStart.fromDirection),this.getWallDirection(e,e.to,i,this.edgeStateOnDragStart.toDirection),i.dot(this.edgeStateOnDragStart.fromDirection)<0&&this.edgeStateOnDragStart.fromDirection.multiplyScalar(-1),i.dot(this.edgeStateOnDragStart.toDirection)<0&&this.edgeStateOnDragStart.toDirection.multiplyScalar(-1)}onWallOpeningMoveStart(e){const t=this.data.getWall(e.wallId),{wallLine:i}=this.openingStateOnDragStart;t.from.getVec3(i.start),t.to.getVec3(i.end);const s=e.width/this.openingStateOnDragStart.wallLine.distance()*.5;this.openingStateOnDragStart.relativeStart=e.relativePos-s,this.openingStateOnDragStart.relativeEnd=e.relativePos+s}onMoveNode(e,t){const i=new V.Vector3,s=this.tryApplySnapping(t,e,i);if(s){const{closestLine:e,orthoLine:t,targetType:i}=s;i===N.LINE||i===N.POINT?i===N.POINT?this.snappingAxesRenderer.showAt(e,t):this.snappingAxesRenderer.showAt(e):this.snappingAxesRenderer.hide()}else this.snappingAxesRenderer.hide();this.data.moveNode(e.id,i)}onMoveWall(e,t){const{initialGrabPt:i,dragDir:s,fromOffset:a,toOffset:o,fromDirection:n,toDirection:r}=this.edgeStateOnDragStart,d=t.clone().sub(i),l=s.dot(d),h=n.clone().multiplyScalar(l),c=i.clone().add(h).add(a),u=r.clone().multiplyScalar(l),m=i.clone().add(u).add(o);this.data.moveWall(e.id,c,m)}onMoveWallOpening(e,t){const{editor:i,openingStateOnDragStart:s}=this,{relativeStart:a,relativeEnd:o,wallLine:n}=s,r=n.closestPointToPointParameter(t,!0);switch(i.state.openingEditState){case _.sO.MOVE:const t=e.width/n.distance()*.5;r+t<1&&r-t>0&&this.data.editWallOpeningDetails(e.id,{relativePos:r});break;case _.sO.START:case _.sO.END:{const t=i.state.openingEditState===_.sO.START?(o-r)*n.distance():(r-a)*n.distance();if(t<H.PW&&t<e.width)return;const s=.5*(r+o);this.data.editWallOpeningDetails(e.id,{relativePos:s,width:t})}}}checkForNodeOrWallHit(e){const t=this.data.getNode(e);return this.mergeOverlapsOnMoveEnd(t)}mergeOverlapsOnMoveEnd(e){const t=e.floorId,i=[],s=new Set,a=new Set,o=[],n=this.data.getNodesByFloor(t);for(const r of n){const n=this.data.getAttachedEntities(r),d=this.data.findNodeOrWallForPosition(r.getVec3(),t,n);if(d)if(d instanceof R.z){const t=[r.id,d.id].sort().join(":");if(!s.has(t)){let o=r.id,n=d.id;if(n===e.id){const e=n;n=o,o=e}a.has(n)||(i.push({keepId:o,mergeId:n}),s.add(t),a.add(n))}}else d instanceof O.c&&o.push(r.id)}const r=this.data.findWallWithWorstOverlaps(t,"colinear"),d=this.data.findWallWithWorstOverlaps(t,"intersection");if(i.length>0||o.length>0||d||r){const e=d?d.wall:void 0,t=r?r.wall:void 0;return this.data.mergeOverlappingEntities(i,o,t,e),!0}return!1}clearHighlightedViews(){this.editor.clearAllHighlights()}hoverView(e){e instanceof z.JJ&&this.hoverRoom(e)}setSelectedView(e){if(!e)return void this.editor.clearAllDims();const t=this.data.getEntity(e);t instanceof O.c&&this.editor.highlight(t.from.id,t.to.id),t instanceof z.JJ&&(this.clearHighlightedViews(),this.dimAllRooms(),this.selectRoom(t))}dimAllRooms(){this.editor.clearAllDims();for(const[,e]of this.data.rooms)this.dimRoom(e)}highlightView(e){if(!e)return;const t=this.data.getEntity(e);t instanceof O.c&&this.editor.highlight(e,t.from.id,t.to.id)}selectRoom(e){const t=e.id;this.editor.clearDim(t);for(const t of e.walls)this.editor.clearDim(t.id);for(const t of e.points)this.editor.clearDim(t.id)}hoverRoom(e){const t=e.id;this.editor.clearDim(t);for(const t of e.walls)this.editor.clearDim(t.id);for(const t of e.points)this.editor.clearDim(t.id)}dimRoom(e){const t=e.id;this.editor.dim(t);for(const t of e.walls)this.editor.dim(t.id);for(const t of e.points)this.editor.dim(t.id)}isSnappingDisabled(){return this.keyboardState.isKeyHeld(W.R.ALT)||this.keyboardState.isKeyHeld(W.R.SHIFT)}tryApplySnapping(e,t,i){if(i.copy(e),!this.isSnappingDisabled()){const s=L(this.data,this.cameraData,t,e);return i.copy(s.target),s}return null}getAttachedWall(e,t){const i=this.data.getWallsForNode(t);if(i)for(const t of i)if(t!==e)return t;return null}getWallDirection(e,t,i,s){const a=this.getAttachedWall(e,t);if(!a)return void s.copy(i);a.getDirection(s).normalize().equals(C.fU.ZERO)&&s.copy(i)}needsWallJoint(e,t,i){const s=this.data.getWallsForNode(t);for(const t of s){if(t===e)continue;const s=i.dot(t.getDirection().normalize());if(Math.abs(s)<.8)return!0}return!1}validate(e,t){return!0}}var j,$=i(10374),q=i(35895),Y=i(89570),Z=i(37721),K=i(67678),X=i(80592),J=i(89553),Q=i(23612),ee=i(86819),te=i(51788),ie=i(82814),se=i(12039),ae=i(94046),oe=i(96154),ne=i(72996),re=i(97998),de=i(15462),le=i(23885),he=i(12529);!function(e){e[e.BASE=he.z.roomBounds]="BASE",e[e.OPENING_STENCIL=he.z.roomBounds+1]="OPENING_STENCIL",e[e.ROOM=he.z.roomBounds+2]="ROOM",e[e.EDGE=he.z.roomBounds+3]="EDGE",e[e.HIGHLIGHTED_EDGE=he.z.roomBounds+4]="HIGHLIGHTED_EDGE",e[e.OPENING_LINES=he.z.roomBounds+5]="OPENING_LINES",e[e.NODE=he.z.roomBounds+6]="NODE"}(j||(j={}));var ce=i(89557);class ue extends V.Mesh{constructor(e,t,i,s){super(t,i),this.roomBoundsId=e,this.cameraData=s,this.animation=new ce.z(0),this.prevColorState={opacity:1,innerColor:new V.Color,outerColor:new V.Color},this.pitchFactor=1,this.raycastEnabled=!0,this.opacity=1,this.selectState={active:!1,on:()=>{this.updateMaterial()},off:()=>{this.updateMaterial()}},this.hoverState={active:!1,on:()=>{this.updateMaterial()},off:()=>this.updateMaterial()},this.highlightState={active:!1,on:()=>this.updateMaterial(),off:()=>this.updateMaterial()},this.dimState={active:!1,on:()=>this.updateMaterial(),off:()=>this.updateMaterial()},this.name=e,this.renderOrder=j.BASE}updateMaterial(){let e=this.colors.baseState;this.dimState.active&&(e=this.colors.dimState),this.hoverState.active&&(e=this.colors.hoverState),(this.highlightState.active||this.selectState.active)&&(e=this.colors.selectState);e!==this.targetColorScheme&&(this.targetColorScheme=e)}tickAnimations(e){this.animation.tick(e)}dispose(){}raycast(e,t){if(!this.raycastEnabled)return;const i=[];super.raycast(e,i),i.length>0&&t.push(i[0])}setPitchFactor(e){this.pitchFactor=e,this.raycastEnabled=(0,T.Eb)(this.pitchFactor)}}var me=i(57216),pe=i.n(me),ge=i(4014),ve=i.n(ge),fe=i(33057),we=i.n(fe),ye=i(56413),Se=i.n(ye),be=i(27706),Ee=i.n(be),De=i(73403),Ie=i.n(De),Ae=i(26274),Ce=i.n(Ae),Oe=i(5311),Re=i.n(Oe);const Me={uniforms:{outlineColor:{type:"v4",value:de.I.BLACK},baseColor:{type:"v4",value:de.I.SINE},outlinePct:{type:"f",value:.8},radius:{type:"f",value:H.pp},opacity:{type:"f",value:1}},vertexShader:pe(),fragmentShader:ve()},Ve={uniforms:{outlineColor:{type:"v3",value:de.I.WHITE},color:{type:"v3",value:de.I.WHITE},lineStart:{type:"v3",value:new V.Vector3},lineEnd:{type:"v3",value:new V.Vector3},width:{type:"f",value:1},selectedWidth:{type:"f",value:.01},opacity:{type:"f",value:1}},vertexShader:we(),fragmentShader:Se()},Te={uniforms:{baseColor:{type:"v4",value:de.I.WHITE},isDoor:{type:"f",value:1},opacity:{type:"f",value:1}},vertexShader:Ee(),fragmentShader:Ie()},xe={uniforms:{opacity:{type:"f",value:1},centerSpacing:{type:"f",value:24},radius:{type:"f",value:4},color:{type:"v4",value:de.I.LENS_GRAY}},vertexShader:Ce(),fragmentShader:Re()};var Ne=i(93411),Le=i(67944);const Pe={baseState:{opacity:1,innerColor:de.I.MIRROR,outerColor:de.I.PORTAL},hoverState:{opacity:1,innerColor:de.I.MIRROR,outerColor:de.I.PORTAL},selectState:{opacity:1,innerColor:de.I.MP_BRAND,outerColor:de.I.WHITE},dimState:{opacity:1,innerColor:de.I.MIRROR,outerColor:de.I.PORTAL}};class Fe extends V.RawShaderMaterial{constructor(){super({fragmentShader:Me.fragmentShader,vertexShader:Me.vertexShader,uniforms:V.UniformsUtils.clone(Me.uniforms),name:"HandleMaterial",transparent:!0,depthTest:!1,extensions:{derivatives:!0}})}}class ke extends ue{constructor(e,t){const i=new Float32Array([-1,0,-1,1,0,-1,1,0,1,-1,0,1]),s=new V.BufferGeometry;s.setAttribute("position",new V.Float32BufferAttribute(i,3)),s.setIndex([0,2,1,0,3,2]),super(e,s,new Fe,t),this.targetRadius=.3,this.prevRadius=.3,this.renderOrder=j.NODE,this.colors=Pe,this.animation.onChanged((()=>this.onAnimationChange())),this.onBeforeRender=()=>{this.material.uniforms.opacity.value=this.opacity*(1-this.pitchFactor)}}onAnimationChange(){const e=this.prevColorState,t=this.targetColorScheme;this.material.uniforms.outlineColor.value.lerpColors(e.outerColor,t.outerColor,this.animation.value),this.material.uniforms.baseColor.value.lerpColors(e.innerColor,t.innerColor,this.animation.value),this.opacity=(0,Ne.t)(e.opacity,t.opacity,this.animation.value);const i=(0,Ne.t)(this.prevRadius,this.targetRadius,this.animation.value);this.setRadius(i)}setPitchFactor(e){super.setPitchFactor(e),this.visible=this.pitchFactor<1}raycast(e,t){const i=[];if(super.raycast(e,i),i.length>0){const s=i[0].point,a=e.ray.origin.distanceTo(this.position),o=(0,Le._U)(a,this.cameraData.pose.projection.asThreeMatrix4(),this.cameraData.width),n=H.Nh*o;s.distanceTo(this.position)<H.pp+n&&t.push(i[0])}}updateMaterial(){this.prevRadius=this.material.uniforms.radius.value,this.targetRadius=H.pp+(this.hoverState.active?H.XG:0)+(this.selectState.active?H.XG:0),super.updateMaterial(),this.prevColorState.innerColor.copy(this.material.uniforms.baseColor.value),this.prevColorState.outerColor.copy(this.material.uniforms.outlineColor.value),this.prevColorState.opacity=this.material.opacity,this.animation.modifyAnimation(0,1,H.rP,le.hl)}setRadius(e){this.material.uniforms.radius.value=e}updatePosition(e){this.position.copy(e)}}class Be extends V.RawShaderMaterial{constructor(){super({fragmentShader:Te.fragmentShader,vertexShader:Te.vertexShader,uniforms:V.UniformsUtils.clone(Te.uniforms),name:"OpeningMaterial",depthTest:!1,transparent:!0,stencilFunc:V.AlwaysStencilFunc,stencilWrite:!1})}}const We=new V.BoxGeometry(1,1,1);class Ue extends ue{constructor(e,t,i){super(e,We.clone(),new Be,i),this.floorId=t,this.onEdgePositionChanged=(()=>{const e=new V.Vector3;return(t,i,s,a)=>{e.subVectors(i,t),this.scale.set(e.length(),.05,s),this.stencilPrepass&&this.stencilPrepass.scale.set(e.length(),.05,s);const o=Math.atan2(i.x-t.x,i.z-t.z)+Math.PI/2;this.rotation.y=o,this.stencilPrepass&&(this.stencilPrepass.rotation.y=o);const n=e.addVectors(i,t).multiplyScalar(.5);this.position.copy(n),this.stencilPrepass&&this.stencilPrepass.position.copy(n),this.startHandle.position.copy(t),this.endHandle.position.copy(i);const r=a===U.u.DOOR?1:0;this.material.uniforms.isDoor.value=r,this.stencilPrepass&&(this.stencilPrepass.material.uniforms.isDoor.value=r)}})(),this.renderOrder=j.OPENING_LINES,this.startHandle=new Ge(e,i,this),this.endHandle=new je(e,i,this),this.animation.onChanged((()=>{this.material.uniforms.baseColor.value.lerpColors(de.I.WHITE,de.I.NEPTUNE,this.animation.value)}))}setPitchFactor(e){super.setPitchFactor(e),this.visible=this.pitchFactor<1,this.startHandle.setPitchFactor(e),this.endHandle.setPitchFactor(e),this.stencilPrepass&&this.stencilPrepass.setPitchFactor(e)}updateMaterial(){const e=this.selectState.active||this.hoverState.active||this.highlightState.active;this.animation.modifyAnimation(this.animation.value,e?1:0,H.rP,le.hl)}tickAnimations(e){super.tickAnimations(e),this.startHandle.tickAnimations(e),this.endHandle.tickAnimations(e)}}class ze extends Ue{constructor(e,t,i){super(e,t,i),this.floorId=t,this.stencilPrepass=new _e(e,t,i)}}class _e extends Ue{constructor(e,t,i){super(e,t,i),this.floorId=t,this.renderOrder=j.OPENING_STENCIL,this.material.colorWrite=!1,this.material.stencilRef=1,this.material.stencilFail=V.ReplaceStencilOp,this.material.stencilZFail=V.ReplaceStencilOp,this.material.stencilZPass=V.ReplaceStencilOp,this.material.stencilFunc=V.AlwaysStencilFunc,this.material.stencilWrite=!0}raycast(e,t){}}class He extends ke{constructor(e,t,i){super(e,t),this.parentOpeningView=i}}class Ge extends He{}class je extends He{}var $e=i(16782),qe=i(92826);var Ye=i(49827),Ze=i(69505),Ke=i(27990);function Xe(e,t,i){const s=function(e){return e/180*Math.PI}(t||0);if(!i||0===i[0]&&0===i[1])return Je(e,s);return Je(e.map(((e,t)=>e-i[t])),s).map(((e,t)=>e+i[t]))}function Je(e,t){return[e[0]*Math.cos(t)-e[1]*Math.sin(t),e[0]*Math.sin(t)+e[1]*Math.cos(t)]}var Qe=i(18810),et=i(53831),tt=i(19810),it=i(5696);function st(e,t,i=0){let s=!1;const a=(0,et.x)(t);for(let t=0,o=a.length-1;t<o;t++)if((0,it.s8)(e,[a[t],a[t+1]],i)){s=!0;break}return s}function at(e,t){let i=!1,s=0;const a=(0,et.x)(e);for(let e=0,o=a.length-1;e<o;e++){const o=a[e],n=a[e+1];if((0,tt.t)([o,n],t)){i=!0;break}if(st(o,t)&&++s,2===s){i=!0;break}}return i}var ot=i(39880);const nt={baseState:{innerColor:de.I.LENS_GRAY,outerColor:de.I.WHITE,opacity:0},hoverState:{innerColor:de.I.NEPTUNE,outerColor:de.I.WHITE,opacity:.5},selectState:{innerColor:de.I.NEPTUNE,outerColor:de.I.WHITE,opacity:0},dimState:{innerColor:de.I.LENS_GRAY,outerColor:de.I.WHITE,opacity:.5}};class rt extends ue{constructor(e,t,i,s,a){const o=rt.getGeoFromRoom(e,t),n=new V.MeshBasicMaterial({color:de.I.LENS_GRAY,depthTest:!1,side:V.DoubleSide,transparent:!0,opacity:0,blending:V.CustomBlending,blendEquation:V.AddEquation,blendSrc:V.SrcAlphaFactor,blendDst:V.DstColorFactor});super(e.id,o,n,i),this.labelManager=s,this.perimeterLabels=[],this.hideMaterial=new V.RawShaderMaterial({vertexShader:xe.vertexShader,fragmentShader:xe.fragmentShader,uniforms:V.UniformsUtils.clone(xe.uniforms),depthTest:!1,side:V.DoubleSide,transparent:!0}),this.getLabelPolygon=(()=>{const e=new V.Vector3,t=[0,0],i=[t,[0,0],[0,0],[0,0],t];return t=>{const s=this.cameraData.pose.position.distanceTo(this.room.getViewCenter()),a=(0,Le._U)(s,this.cameraData.pose.projection.asThreeMatrix4(),this.cameraData.width),o=t.split("\n"),n=o.reduce(((e,t)=>Math.max(e,t.length)),0),r=(0,Ke.hJ)(n,0,0),d=this.room.getViewCenter(),l=d.x,h=d.z,c=.5*r.width*a,u=.5*r.height*a*o.length;return e.set(l-c,0,h-u),e.applyQuaternion(this.cameraData.pose.rotation),i[0][0]=l-c,i[0][1]=h-u,i[1][0]=l+c,i[1][1]=h-u,i[2][0]=l+c,i[2][1]=h+u,i[3][0]=l-c,i[3][1]=h+u,i}})(),this.standardMaterial=n,this.renderOrder=j.ROOM,this.roomLabel=this.labelManager.createRoomLabel(e.floorId),this.roomLabel.addTo(this),this.roomLabel.setVisible(!e.hide),this.room=e,this.calculateMaxLabelSize(),this.updateLabelPosition(e,t),this.updatePerimeterLabels(a),this.colors=nt,this.animation.onChanged((()=>{const e=this.prevColorState;this.standardMaterial.color.lerpColors(e.innerColor,this.targetColorScheme.innerColor,this.animation.value);const t=(0,Ne.t)(e.opacity,this.targetColorScheme.opacity,this.animation.value);this.opacity=t,this.hideMaterial.uniforms.opacity.value=this.roomLabel.label.opacity})),this.onBeforeRender=()=>{this.standardMaterial.opacity=this.opacity*(1-this.pitchFactor)}}dispose(){this.labelManager.deleteLabel(this.roomLabel);for(const e of this.perimeterLabels)this.labelManager.deleteLabel(e),e.dispose();super.dispose()}updateGeo(e,t,i){this.room=e;const s=rt.getGeoFromRoom(e,t);this.geometry.dispose(),this.geometry=s,this.geometry.computeBoundingBox(),this.calculateMaxLabelSize(),this.updateLabelPosition(e,t),this.updateLabelElipsis(),this.updatePerimeterLabels(i)}updateLabelBillboard(){const{position:e,rotation:t,projection:i}=this.cameraData.pose,{height:s}=this.cameraData,a=this.cameraData.isOrtho()?this.cameraData.zoom():1,o=this.cameraData.aspect();this.roomLabel.label.quaternion.copy(t),this.roomLabel.label.scaleBillboard(e,t,i,a,s,o,.1),this.updateLabelElipsis();for(const e of this.perimeterLabels)e.update();this.updateMaterial()}setLabelVisible(e){for(const t of this.perimeterLabels)t.setVisible(e)}updateMaterial(){this.material=this.room.hide?this.hideMaterial:this.standardMaterial,super.updateMaterial(),this.hoverState.active&&(this.targetColorScheme=this.colors.hoverState),this.standardMaterial.blending=this.hoverState.active?V.CustomBlending:V.NormalBlending;const e=this.standardMaterial;this.prevColorState.innerColor.copy(e.color),this.prevColorState.opacity=e.opacity,this.animation.modifyAnimation(0,1,H.rP,le.hl),this.roomLabel.setDimmed(this.dimState.active),this.roomLabel.setVisible(!this.room.hide||this.hoverState.active)}updateLabelPosition(e,t){this.roomLabel.label.position.copy(e.getViewCenter().clone().add(new V.Vector3(0,t,0)))}updateText(e,t){this.labelText=e,this.areaText=t,this.updateLabelElipsis()}static getGeoFromRoom(e,t){const i=e.points.map((e=>e.getVec2())),s=new V.Shape(i);s.holes=e.holesCW.map((e=>new V.Path(e.map((e=>e.getVec2())))));const a=new V.ShapeGeometry(s);return a.rotateX(Math.PI/2),a.translate(0,t,0),a}updateLabelElipsis(){if(!this.areaText||!this.labelText)return;const e=this.cameraData.pose.position.distanceTo(this.room.getViewCenter()),t=(0,Le._U)(e,this.cameraData.pose.projection.asThreeMatrix4(),this.cameraData.width),i=(new V.Euler).setFromQuaternion(this.cameraData.pose.rotation).z,s=Ze.MN*i,a=this.room.getViewCenter(),o=[a.x,a.z],n=function(e,t,i){let s=[];for(let a=0,o=e.length;a<o;a++)s[a]=Xe(e[a],t,i);return s}(this.maxLabelPolygon,s,o);let r=Number.MAX_SAFE_INTEGER,d=Number.MIN_SAFE_INTEGER;n.forEach((([e,t])=>{r=Math.min(r,e),d=Math.max(d,e)}));const l=Math.abs(d-r)/t,h=Math.round((l-5)/9),c=this.areaText.length>0&&!this.room.hide?"\n"+this.areaText:"",u=(0,ot.aS)(this.labelText,h-3),m=[this.labelText+c,u+c];let p=u;for(const e of m){const t=this.getLabelPolygon(e);if((0,Qe.D)(t,this.roomPolygon)){p=e;break}}this.roomLabel.label.text=p}calculateMaxLabelSize(){const e=this.room.bbox.getSize(new V.Vector2),t=.1*Math.min(e.x,e.y),i=this.room.getViewCenter(),s=this.room.points.map((e=>[e.x,e.z]));s.push(s[0]);const a=this.room.holesCW.map((e=>e.map((e=>[e.x,e.z])))),o=()=>{if(!(0,Qe.D)(l,s))return!1;for(const e of a)if(at(e,l))return!1;return!0},n=i.x,r=i.z,d=[];d.push([n-t,r-t]),d.push([n+t,r-t]),d.push([n+t,r+t]),d.push([n-t,r+t]),d.push(d[0]);const l=d;for(;o();)l[0][0]-=t,l[1][0]+=t,l[2][0]+=t,l[3][0]-=t;for(l[0][0]+=t,l[1][0]-=t,l[2][0]-=t,l[3][0]+=t;o();)l[0][1]-=t,l[1][1]-=t,l[2][1]+=t,l[3][1]+=t;l[0][1]+=t,l[1][1]+=t,l[2][1]-=t,l[3][1]-=t,this.maxLabelPolygon=l,this.roomPolygon=s}updatePerimeterLabels(e){const t=this.room.hide?[]:this.room.minimalInnerLoop;for(;t.length>this.perimeterLabels.length;)this.perimeterLabels.push(this.labelManager.createPerimeterLabel(this.room.floorId).addTo(this));for(;t.length<this.perimeterLabels.length;){const e=this.perimeterLabels.pop();if(!e)throw new Error("Label should exist!");this.labelManager.deleteLabel(e)}for(let i=0;i<t.length;i++){const s=t[i];this.perimeterLabels[i].updateDimensions(s.start.clone(),s.end.clone(),0,e)}}}var dt,lt=i(61011),ht=i(10840);!function(e){e[e.PIXELS=0]="PIXELS",e[e.METERS=1]="METERS"}(dt||(dt={}));class ct extends V.Mesh{constructor(e,t,i){const s=new Float32Array([-9999,-9999,-9999,9999,9999,9999,-9999,-9999,-9999,9999,9999,9999,9999,9999,9999,-9999,-9999,-9999]),a=new Float32Array([1,1,0,0,-1,-1]),o=new Float32Array([0,1,0,1,0,1]),n=new V.BufferGeometry;n.setAttribute("position",new V.Float32BufferAttribute(s,3)),n.setAttribute("offsetDirection",new V.Float32BufferAttribute(a,1)),n.setAttribute("t",new V.Float32BufferAttribute(o,1)),n.setIndex([0,2,1,2,3,1,2,4,3,4,5,3]);let r={},d={};(null==i?void 0:i.dashUnits)===dt.METERS&&(r={WORLDSPACE_DASH:!0},d={derivatives:!0});super(n,new V.RawShaderMaterial({uniforms:V.UniformsUtils.clone(ht.T.screenline.uniforms),side:V.FrontSide,vertexShader:ht.T.screenline.vertexShader,fragmentShader:ht.T.screenline.fragmentShader,transparent:!0,depthTest:i.depthTest,depthWrite:i.depthWrite,depthFunc:i.depthFunc,defines:r,extensions:d})),this.updateEndpoints(e,t),this.geometry.computeBoundingBox(),this.geometry.computeBoundingSphere(),this.renderOrder=he.z.lines,this.onBeforeRender=e=>{e.getSize(this.material.uniforms.screenSize.value)},this.material.uniforms.dashed.value=+i.dashed,this.material.uniforms.dashSize.value=i.dashSize,this.material.uniforms.gapSize.value=i.gapSize,this.material.uniforms.lineWidth.value=i.lineWidth,this.material.uniforms.color.value.copy(i.color),this.material.uniforms.opacity.value=i.opacity}updateEndpoints(e,t){this.material.uniforms.start.value.copy(e),this.material.uniforms.end.value.copy(t)}opacity(e){this.material.uniforms.opacity.value=e}color(e){this.material.uniforms.color.value.copy(e)}}const ut={baseState:{innerColor:de.I.WHITE,outerColor:de.I.WHITE,opacity:1},hoverState:{innerColor:de.I.WHITE,outerColor:de.I.NEPTUNE,opacity:1},selectState:{innerColor:de.I.WHITE,outerColor:de.I.NEPTUNE,opacity:1},dimState:{innerColor:de.I.WHITE,outerColor:de.I.WHITE,opacity:.5}};class mt extends ue{constructor(e,t,i){const s=new Float32Array([0,0,0,1,0,0,1,0,1,0,0,1,-1,0,1,-1,0,0,1,0,2,-1,0,2,-1,0,-1,1,0,-1]),a=new V.BufferGeometry;a.setAttribute("position",new V.Float32BufferAttribute(s,3)),a.setIndex([0,1,2,0,2,3,0,3,4,0,4,5,3,2,6,3,7,4,0,9,1,0,5,8]);super(e,a,new V.RawShaderMaterial({uniforms:V.UniformsUtils.clone(Ve.uniforms),vertexShader:Ve.vertexShader,fragmentShader:Ve.fragmentShader,transparent:!0,depthTest:!1,stencilRef:1,stencilFail:V.KeepStencilOp,stencilZFail:V.KeepStencilOp,stencilZPass:V.KeepStencilOp,stencilFunc:V.GreaterStencilFunc,stencilWrite:!0,extensions:{derivatives:!0}}),t),this.lineLabel=i,this.line3=new V.Line3(new V.Vector3,new V.Vector3),this.widthCache=.1,this.updateMaterial=()=>{super.updateMaterial();const e=this.material.uniforms;this.prevColorState.innerColor.copy(e.color.value),this.prevColorState.outerColor.copy(e.outlineColor.value),this.prevColorState.opacity=e.opacity.value;const t=this.selectState.active||this.highlightState.active,i=this.hoverState.active;this.renderOrder=t||i?j.HIGHLIGHTED_EDGE:j.EDGE,this.animation.modifyAnimation(0,1,H.rP,le.hl)},this.raycast=(()=>{const e=new V.Vector3,t=new V.Vector2,i=new V.Vector2;return(s,a)=>{const o=this.line3.closestPointToPoint(s.ray.origin,!0,e);t.set(o.x,o.z),i.set(s.ray.origin.x,s.ray.origin.z);const n=t.distanceTo(i),r=s.ray.origin.distanceTo(this.line3.start),d=(0,Le._U)(r,this.cameraData.pose.projection.asThreeMatrix4(),this.cameraData.width),l=H.Nh*d;n<.5*this.widthCache+l&&a.push({distance:r,object:this,point:o.clone(),face:{a:-1,b:-1,c:-1,materialIndex:-1,normal:new V.Vector3(0,1,0)}})}})(),this.onEdgePositionChanged=(()=>{const e=new V.Vector3,t=new V.Vector3,i=new V.Vector3,s=new V.Vector3,a=new V.Vector3,o=new V.Vector3,n=new V.Vector3;return(r,d,l)=>{var h;const c=r.getWall(this.roomBoundsId),u=(null===(h=d.floors.getFloor(c.floorId))||void 0===h?void 0:h.bottom)||0;c.from.getVec3(e),c.to.getVec3(t);const m=this.geometry.getAttribute("position");c.getBiasAdjustmentVec(n),i.set(e.x,e.y+u,e.z),s.set(t.x,t.y+u,t.z),a.addVectors(i,n),o.addVectors(s,n),this.line3.start.copy(a),this.line3.end.copy(o),this.material.uniforms.lineStart.value.copy(a),this.material.uniforms.lineEnd.value.copy(o),this.material.uniforms.width.value=c.width,this.widthCache=c.width,this.lineLabel.updateDimensions(a,o,c.width,l),m.setXYZ(0,i.x,i.y,i.z),m.setXYZ(3,s.x,s.y,s.z);const{fromLeft:p,fromRight:g,toLeft:v,toRight:f}=(0,lt.b)(c,r);m.setXYZ(1,g.primary.x,g.primary.y+u,g.primary.z),m.setXYZ(2,f.primary.x,f.primary.y+u,f.primary.z),m.setXYZ(4,v.primary.x,v.primary.y+u,v.primary.z),m.setXYZ(5,p.primary.x,p.primary.y+u,p.primary.z),m.setXYZ(9,g.bevel.x,g.bevel.y+u,g.bevel.z),m.setXYZ(6,f.bevel.x,f.bevel.y+u,f.bevel.z),m.setXYZ(7,v.bevel.x,v.bevel.y+u,v.bevel.z),m.setXYZ(8,p.bevel.x,p.bevel.y+u,p.bevel.z),m.needsUpdate=!0,this.perspectiveLine.updateEndpoints(i,s),this.occlusionLine.updateEndpoints(i,s),this.geometry.computeBoundingBox(),this.geometry.computeBoundingSphere()}})(),this.renderOrder=j.EDGE,this.geometry.computeBoundingBox(),this.geometry.computeBoundingSphere();const o={dashed:!1,dashSize:1,gapSize:1,lineWidth:1,color:de.I.WHITE,dashUnits:dt.METERS,depthWrite:!1,depthTest:!0,depthFunc:V.LessDepth,opacity:1},n={dashed:!0,dashSize:.08,gapSize:.04,lineWidth:1,color:de.I.WHITE,dashUnits:dt.METERS,depthWrite:!1,depthTest:!0,depthFunc:V.GreaterDepth,opacity:1};this.occlusionLine=new ct(new V.Vector3,new V.Vector3,n),this.perspectiveLine=new ct(new V.Vector3,new V.Vector3,o),this.add(this.perspectiveLine),this.add(this.occlusionLine),this.colors=ut,this.material.uniforms.selectedWidth.value=.03;const r=de.I.WHITE.clone();this.animation.onChanged((()=>{const e=this.prevColorState,t=this.targetColorScheme;this.material.uniforms.outlineColor.value.lerpColors(e.outerColor,t.outerColor,this.animation.value);this.material.uniforms.color.value.lerpColors(e.innerColor,t.innerColor,this.animation.value);const i=(0,Ne.t)(e.opacity,t.opacity,this.animation.value);this.opacity=i,r.copy(de.I.WHITE).multiplyScalar(this.opacity),this.occlusionLine.color(r),this.perspectiveLine.color(r)})),this.onBeforeRender=()=>{this.material.depthTest=1===this.pitchFactor,this.material.uniforms.opacity.value=(1-this.pitchFactor)*this.opacity,this.occlusionLine.opacity(this.pitchFactor),this.perspectiveLine.opacity(this.pitchFactor),this.lineLabel.update()}}tickAnimations(e){super.tickAnimations(e),this.lineLabel.tickAnimations(e)}setLabelVisible(e){this.lineLabel.setVisible(e)}dispose(){super.dispose(),this.lineLabel.dispose()}}const pt=new re.Z("room-bounds-editor"),gt=e=>{const t=pt.debug;return(0,q.k1)((()=>t(`${e}.renew()`)),(()=>t(`${e}.cancel()`)),!1)};class vt extends E.M.DragAndDrop{constructor(e,t,i,s,a,o,n,r,d){super(new _.oE),this.getCursorOrigin=e,this.input=t,this.raycaster=i,this.messageBus=s,this.data=a,this.floorsViewData=o,this.cameraPoseData=n,this.commandBinder=r,this.clearSelectionIfNeeded=e=>{this.state.currentId===e.id&&this.deselect()},this.allViewsComparator=ne.s.is((e=>this.state.toolState===E.M.ToolState.READ_ONLY||this.state.toolState===E.M.ToolState.SELECTED_READ_ONLY?e instanceof rt:e instanceof ue)),this.draggableViewsComparator=ne.s.is((e=>(e instanceof mt||e instanceof ze||e instanceof ke)&&!!e.raycastEnabled)),this.addPoint=e=>{if(e.button!==$e.M.PRIMARY)return;const t=this.getCurrentRoomBoundHit(),i=this.getCursorOrigin(),s={x:i.x,z:i.z};switch(this.data.finalizeHistory(),this.state.addType){case _.RE.WALLS:{const{wallType:e}=this.state,a=this.data.getLastWallWidth(e);if(t)if(t instanceof R.z){const{wall:i}=this.data.addTrailingEdgeToNode(e,t.id,s,a);this.add(i)}else if(t instanceof O.c){const o=t.getProjection(i),{newTrailingWall:n}=this.data.addTrailingEdgeToEdge(e,t.id,o,s,a);this.add(n.id)}else{if(!(t instanceof z.JJ||t instanceof U.E))throw new Error("Trying to add a new Edge on an invalid object type");this.addFirstFloatingPoint(s)}else this.addFirstFloatingPoint(s)}break;case _.RE.DOORS:case _.RE.OPENINGS:{const e=this.state.tempHoverPreviewEntityId;e&&(this.data.finalizeHistory(),setTimeout((()=>this.select(e)),1),this.state.tempHoverPreviewEntityId=null)}}},this.moveTemporaryPreview=()=>{const e=new V.Line3;return(()=>{const t=this.state.tempHoverPreviewEntityId;if(t){if(this.state.addType!==_.RE.DOORS&&this.state.addType!==_.RE.OPENINGS)return void this.deleteTemporaryPreview();const i=this.data.getOpening(t),s=this.data.getWall(i.wallId).getLine3(e),a=this.getCursorOrigin(),o=s.closestPointToPointParameter(a,!0),n=i.width/s.distance()*.5;o+n<1&&o-n>0&&this.data.editWallOpeningDetails(t,{relativePos:o})}})()},this.mergePointAndStartNewWall=e=>{this.tryCommit()},this.updateCursor=()=>{const{toolState:e,pendingValid:t,pendingAdd:i,pendingEdit:s,currentId:a}=this.state;let o=g.C.ROOMBOUNDS_DEFAULT;if((e===E.M.ToolState.ADDING||e===E.M.ToolState.WAIT_FOR_ADD)&&a){o=g.C.ROOMBOUNDS_PLACE_NODE;const t=e===E.M.ToolState.ADDING?this.data.getWall(a).to.id:a;if(t)try{const e=((e,t,i,s=!1)=>{const a=t.getAttachedEntities(e),o=s?e.getVec3():void 0;return i.getCurrentRoomBoundHit(a,o)})(this.data.getNode(t),this.data,this);e&&(e instanceof O.c||e instanceof R.z)&&(o=g.C.ROOMBOUNDS_FINISH_ROOM)}catch(e){}}this.state.dragging&&(o=g.C.ROOMBOUNDS_MOVING),(i||s)&&!1===t&&(o=g.C.NOPE),this.state.cursor!==o&&(this.state.cursor=o,this.state.commit())};const l=[this.subscribe(E.M.Events.StateChange,(async({target:e})=>{this.inputStates||(this.inputStates=this.bindInputToEditorStates(d)),this.inputStates.cancel(),this.inputStates.renew(e)})),this.subscribe(E.M.Events.CurrentChange,this.updateCursor),this.subscribe(E.M.Events.ValidChange,this.updateCursor),this.subscribe(E.M.Events.HoverChange,this.updateCursor),this.input.registerHandler(K.mE,this.updateCursor),this.data.onNodesChanged({onRemoved:this.clearSelectionIfNeeded}),this.data.onWallsChanged({onRemoved:this.clearSelectionIfNeeded}),this.data.onOpeningsChanged({onRemoved:this.clearSelectionIfNeeded}),this.data.onRoomsChanged({onRemoved:this.clearSelectionIfNeeded})];l.forEach((e=>e.cancel())),this.bindings.push(...l)}exit(){super.exit(),this.inputStates&&this.inputStates.cancel()}bindInputToEditorStates(e){const t=new Y.V(this.input.registerPriorityHandler(X._t,ie.S,(()=>!0)),this.input.registerPriorityHandler(X._t,ae.i,(()=>!0)));t.cancel();const i=()=>this.setEnabled(!1),s=()=>this.setEnabled(!0),a=()=>this.exit(),o=new Y.V((0,q.k1)((()=>this.messageBus.subscribe(oe.oR,i)),(()=>this.messageBus.unsubscribe(oe.oR,i)),!1),(0,q.k1)((()=>this.messageBus.subscribe(oe.NR,s)),(()=>this.messageBus.unsubscribe(oe.NR,s)),!1),(0,q.k1)((()=>this.messageBus.subscribe($.bS,a)),(()=>this.messageBus.unsubscribe($.bS,a)),!1),this.cameraPoseData.onChanged((()=>{this.state.toolState!==E.M.ToolState.CLOSED&&this.setEnabled(this.cameraPoseData.pitchFactor()<1)}))),n=new Y.V(this.input.registerUnfilteredHandler(J.e,(e=>{e.key===W.R.ESCAPE&&this.discard(),e.key===W.R.RETURN&&this.tryCommit()})));n.cancel();const r=new qe.r(e,"keydown",(e=>{"KeyZ"===e.code&&(e.ctrlKey||e.metaKey)&&this.commandBinder.issueCommand(new A.o3)}));r.cancel();const d=new Y.V(this.input.registerMeshHandler(Q.z,this.allViewsComparator,((e,t)=>this.hover(t.roomBoundsId,t))),this.input.registerMeshHandler(Q.A,this.allViewsComparator,(()=>this.unhover())));d.cancel();const l=this.input.registerUnfilteredHandler(J.e,(e=>{e.key===W.R.ESCAPE&&this.deselect()}));l.cancel();const h=this.input.registerUnfilteredHandler(J.e,(e=>{const t=[W.R.DELETE,W.R.BACKSPACE].includes(e.key);if(this.state.pendingEdit&&t){const{currentId:e}=this.state;e&&(this.discard(),this.data.deleteEntity(e),this.data.finalizeHistory())}}));h.cancel();const c=new Y.V(this.input.registerPriorityHandler(ee.R,ie.S,(()=>(this.deselect(),!0))),this.input.registerPriorityHandler(ee.R,ae.i,(()=>(this.deselect(),!0))));c.cancel();const u=new Y.V(this.input.registerMeshHandler(ee.R,this.allViewsComparator,this.onToggleSelectInput.bind(this)),this.input.registerMeshHandler(X.u4,this.allViewsComparator,this.onToggleSelectInput.bind(this)),this.input.registerMeshHandler(X._t,this.draggableViewsComparator,this.onToggleSelectInput.bind(this)));u.cancel();const m=this.input.registerUnfilteredHandler(ee.R,this.addPoint),p=this.input.registerUnfilteredHandler(ee.R,this.mergePointAndStartNewWall),g=new Y.V(this.input.registerMeshHandler(X.u4,this.draggableViewsComparator,this.placeOnDrag.bind(this)),this.input.registerMeshHandler(X.Zv,this.draggableViewsComparator,this.onDragEnd.bind(this)));g.cancel();const v=this.input.registerUnfilteredHandler(K.mE,(e=>this.move(e)));v.cancel();const f=this.input.registerUnfilteredHandler(K.er,this.dropOnPointerUp.bind(this));f.cancel();const w=this.input.registerUnfilteredHandler(K.mE,this.moveTemporaryPreview.bind(this));w.cancel();const y=this.input.registerUnfilteredHandler(K.er,(e=>{e.button===$e.M.PRIMARY&&this.updateCursor()})),S=(0,q.k1)((()=>{this.commandBinder.issueCommand(new se.ZK),this.commandBinder.issueCommand(new te.t)}),(()=>{this.commandBinder.issueCommand(new se.Lp),this.commandBinder.issueCommand(new te.U)}),!1),b=new Y.V(o,d,u,gt("ToolState.READ_ONLY -> bindings")),D=new Y.V(o,d,u,g,y,r,gt("ToolState.IDLE -> bindings")),I=new Y.V(o,n,d,w,m,S,gt("ToolState.WAIT_FOR_ADD -> bindings")),C=new Y.V(o,n,v,d,p,S,r,gt("ToolState.ADDING -> bindings")),O=[o,u,d,y,l,c],R=[g,r,h],M=new Y.V(...O,...R,gt("ToolState.SELECTED -> bindings")),V=new Y.V(...O,gt("ToolState.SELECTED_READ_ONLY -> bindings")),T=new Y.V(o,t,n,d,gt("ToolState.PLACING -> (base) bindings")),x=new Y.V(...O,...R,gt("ToolState.EDITING -> bindings"));return new Z.U([{state:E.M.ToolState.DISABLED,subs:[o]},{state:E.M.ToolState.READ_ONLY,subs:[b]},{state:E.M.ToolState.IDLE,subs:[D]},{state:E.M.ToolState.WAIT_FOR_ADD,subs:[I]},{state:E.M.ToolState.ADDING,subs:[C]},{state:E.M.ToolState.SELECTED,subs:[M]},{state:E.M.ToolState.SELECTED_READ_ONLY,subs:[V]},{state:E.M.ToolState.EDITING,subs:[x]},{state:E.M.ToolState.PLACING,subs:[T,v,f]}])}getCurrentRoomBoundHit(e,t){let i;const s=e=>e instanceof ue,a=e=>s(e.object);if(null==t)i=this.input.getCurrentRayHits().filter(a);else{const e=t.clone().add(new V.Vector3(0,1e3,0));i=this.raycaster.picking.cast(e,C.fU.DOWN,s)}let o=i.filter(a).map((e=>e.object.roomBoundsId));return e&&(o=o.filter((t=>!e.has(t)))),o.length>0?this.data.getEntity(o[0]):null}onToggleSelectInput(e,t){this.updateOpeningEditState(t);const i=t.roomBoundsId;i&&setTimeout((()=>{if(t.parent){if(this.state.selected===i)e instanceof ee.R&&(this.discard(),this.deselect());else{const e=this.state.toolState;e!==E.M.ToolState.EDITING&&e!==E.M.ToolState.PLACING||this.discard(),this.select(i),e!==E.M.ToolState.READ_ONLY&&e!==E.M.ToolState.SELECTED_READ_ONLY&&this.edit(i),this.hover(i)}}}),0)}hover(e,t){super.hover(e),t&&this.handleOpeningHover(t),this.state.tempHoverPreviewEntityId&&this.state.tempHoverPreviewEntityId!==e&&this.deleteTemporaryPreview();const i=this.state.toolState===E.M.ToolState.ADDING||this.state.toolState===E.M.ToolState.WAIT_FOR_ADD,s=this.state.addType===_.RE.DOORS||this.state.addType===_.RE.OPENINGS;if(i&&s){const e=this.getCurrentRoomBoundHit(),t=this.getCursorOrigin(),i=this.addOpeningOrDoor(e,t);i&&(this.state.tempHoverPreviewEntityId=i)}}handleOpeningHover(e){const t=e=>{e.hoverState.active=!1,e.hoverState.off()};if(e instanceof ze)t(e.startHandle),t(e.endHandle);else if(e instanceof He){t(e instanceof Ge?e.parentOpeningView.endHandle:e.parentOpeningView.startHandle)}}placeOnDrag(e,t){if(e instanceof X._t&&e.buttons!==$e.r.PRIMARY||e instanceof X.u4&&e.pointer.buttons!==$e.r.PRIMARY)return;this.updateOpeningEditState(t);const i=t.roomBoundsId;this.state.selected!==i&&this.select(i),this.place(i),this.state.dragging=!0}onDragEnd(e){this.state.dragging=!1}updateOpeningEditState(e){this.state.openingEditState=e instanceof Ge?_.sO.START:e instanceof je?_.sO.END:_.sO.MOVE}dropOnPointerUp(e){if(e.down)this.updateCursor();else{!1!==this.state.pendingValid?this.tryCommit():this.discard()}}addOpeningOrDoor(e,t){if(!(e instanceof O.c))return null;const i=e.getProjection(t)/e.length,s=Math.min(.9*e.length,.9144),a=s/e.length*.5,o=(0,Ye.uZ)(i,a,1-a);return this.data.addWallOpening({wallId:e.id,type:this.state.addType===_.RE.DOORS?U.u.DOOR:U.u.OPENING,relativePos:o,width:s})}deleteTemporaryPreview(){this.state.tempHoverPreviewEntityId&&this.data.tryGetEntity(this.state.tempHoverPreviewEntityId)&&(this.data.deleteEntity(this.state.tempHoverPreviewEntityId),this.state.tempHoverPreviewEntityId=null)}addFirstFloatingPoint(e){if(!this.floorsViewData.currentFloorId)throw new Error("Expected a floor when adding point.");const{wall:t}=this.data.addFloatingEdge(this.state.wallType,e,Object.assign({},e),this.data.getLastWallWidth(this.state.wallType),this.floorsViewData.currentFloorId);this.add(t)}}var ft=i(26158),wt=i(69739),yt=i(56159),St=i(46391),bt=i(84784);class Et extends ke{}var Dt,It=i(82582),At=i.n(It),Ct=i(67971),Ot=i(37519),Rt=i(72119);class Mt{constructor(){this.corner=[new V.Vector2,new V.Vector2,new V.Vector2,new V.Vector2],this.axis=[new V.Vector2,new V.Vector2],this.origin=[0,0],this.aabb=new V.Box2}set(e){if(4!==e.length)throw new Error("Obb needs four points!");for(let t=0;t<e.length;t++)this.corner[t].copy(e[t]);this.aabb.setFromPoints(this.corner),this.axis[0].subVectors(this.corner[1],this.corner[0]),this.axis[1].subVectors(this.corner[3],this.corner[0]);for(let e=0;e<2;e++)this.axis[e].divideScalar(this.axis[e].lengthSq()),this.origin[e]=this.corner[0].dot(this.axis[e])}overlaps(e){return this.overlaps1Way(e)&&e.overlaps1Way(this)}overlaps1Way(e){for(let t=0;t<2;t++){let i=e.corner[0].dot(this.axis[t]),s=i,a=i;for(let o=1;o<4;o++)i=e.corner[o].dot(this.axis[t]),s=Math.min(s,i),a=Math.max(a,i);if(s>1+this.origin[t]||a<this.origin[t])return!1}return!0}}class Vt{constructor(e,t,i,s){this.cameraData=i,this.debugContainer=s,this.labels=new Set,this.tree=new(At()),this.roomLabelMaker=new Ct.uc({assetBasePath:e,lang:t,color:"white",outline:!0,background:!1,backgroundColliderType:Nt,disableDepth:!0}),this.wallLabelMaker=new Ct.uc({assetBasePath:e,color:"black",lang:t,background:!0,backgroundColor:"#ffffff",backgroundColliderType:Nt,disableDepth:!0})}createRoomLabel(e){const t=new Tt(Dt.ROOM,e,this.roomLabelMaker.createLabel());return this.labels.add(t),t}createWallLabel(e){const t=new xt(Dt.WALL,e,this.wallLabelMaker.createLabel(),this.cameraData);return this.labels.add(t),t}createPerimeterLabel(e){const t=new xt(Dt.PERIMETER,e,this.wallLabelMaker.createLabel(),this.cameraData);return this.labels.add(t),this.update(),t}deleteLabel(e){e.label.parent&&e.removeFrom(e.label.parent),this.labels.delete(e),e.dispose()}tickAnimations(e){for(const t of this.labels)t.tickAnimations(e)}update(){const e=new V.Vector2,t=new V.Vector3,i=new V.Vector3,s=[{x:-1,y:-1,screenPos:new V.Vector2},{x:1,y:-1,screenPos:new V.Vector2},{x:1,y:1,screenPos:new V.Vector2},{x:-1,y:1,screenPos:new V.Vector2}],a=[];this.debugContainer&&this.debugContainer.clear();const o=(0,Le.Pp)(this.cameraData.pose.projection),n=Array.from(this.labels).filter((e=>e.labelVisible)).sort(((e,t)=>{const i=e.floorId.localeCompare(t.floorId);if(0!==i)return i;const s=e.type-t.type;if(0!==s)return s;const a=t.length-e.length;return 0!==a?a:e.label.id-t.label.id})).map((n=>{const r=n.label,d=o?Math.abs(r.position.y-this.cameraData.pose.position.y):this.cameraData.pose.position.distanceTo(r.position),l=(0,Le._U)(d,this.cameraData.pose.projection.asThreeMatrix4(),this.cameraData.width)*H.bk;(0,T.q9)(this.cameraData,r.position,e,t);const{width:h,height:c}=r.getUnscaledSize();this.debugContainer&&(a.length=0),r.updateMatrixWorld();for(const e of s)i.set(h*e.x*.5+l*e.x,c*e.y*.5+(l+e.y),0),i.applyMatrix4(r.matrixWorld),this.debugContainer&&a.push(i.clone()),(0,T.q9)(this.cameraData,i,e.screenPos);if(this.debugContainer){const e=new V.Mesh(new V.ShapeGeometry(new V.Shape(a.map((e=>new V.Vector2(e.x,e.z))))).rotateX(Math.PI/2),new V.MeshBasicMaterial({color:"red",depthTest:!1,side:V.DoubleSide}));this.debugContainer.add(e)}const u=new Mt;u.set(s.map((e=>e.screenPos)));const m=u.aabb;return{label:n,oob:u,minX:m.min.x,minY:m.min.y,maxX:m.max.x,maxY:m.max.y}}));let r="";for(const e of n){r!==e.label.floorId&&(this.tree.clear(),r=e.label.floorId);const t=this.tree.search(e).find((t=>t.oob.overlaps(e.oob)));e.label.setCollides(!!t),t||this.tree.insert(e)}for(const e of this.labels)e.update()}}!function(e){e[e.ROOM=0]="ROOM",e[e.WALL=1]="WALL",e[e.PERIMETER=2]="PERIMETER"}(Dt||(Dt={}));class Tt{constructor(e,t,i){this.type=e,this.floorId=t,this.label=i,this.length=0,this.labelOpacityAnimation=new ce.z(1),this.labelVisible=!1,this.collides=!1,this.dimmed=!1,this.label.setRenderOrder(he.z.labels),this.updateOpacityTarget(0)}addTo(e){return e.add(this.label),this}removeFrom(e){e.remove(this.label)}dispose(){this.label.dispose()}tickAnimations(e){this.labelOpacityAnimation.tick(e)}setVisible(e){e!==this.labelVisible&&(this.labelVisible=e,this.updateOpacityTarget())}setCollides(e){e!==this.collides&&(this.collides=e,this.updateOpacityTarget(e?0:H.rP))}setDimmed(e){e!==this.dimmed&&(this.dimmed=e,this.updateOpacityTarget())}update(){this.updateOpacity()}updateOpacity(){this.label.opacity=this.labelOpacityAnimation.value}updateOpacityTarget(e=H.rP){const t=this.dimmed?.5:1,i=this.labelVisible&&!this.collides?t:0;this.labelOpacityAnimation.modifyAnimation(e>0?this.labelOpacityAnimation.value:i,i,e)}}class xt extends Tt{constructor(e,t,i,s){super(e,t,i),this.cameraData=s,this.start=new V.Vector3,this.end=new V.Vector3,this.width=.1,this.getLinePositions=(()=>{const e=new V.Vector3,t=new V.Vector3,i=new V.Vector3,s=new V.Vector3,a=new V.Vector3;return()=>{e.copy(this.start),t.copy(this.end);const o=(0,Ke.Ko)(e,t,this.cameraData),n=(0,Ke.hJ)(this.label.text.length),r=o.pixelDistance>n.width&&this.labelVisible;this.setVisible(r);const d=this.cameraData.isOrtho(),l=d?Math.abs(this.label.position.y-this.cameraData.pose.position.y):this.cameraData.pose.position.distanceTo(this.label.position);i.addVectors(e,t).multiplyScalar(.5),d?(a.subVectors(t,e),a.applyAxisAngle(C.fU.UP,.5*Math.PI).normalize()):a.copy(C.fU.UP);const h=(0,Le._U)(l,this.cameraData.pose.projection.asThreeMatrix4(),this.cameraData.width),c=d?4:10;return s.copy(i),s.addScaledVector(a,.5*this.width+.75*this.label.scale.x+h*c),{start:e,end:t,center:i,labelPosition:s,lineRotation:o.rotation}}})()}updateDimensions(e,t,i,s){this.start.copy(e),this.end.copy(t),this.width=i;const a=this.start.distanceTo(this.end);this.length=a;const o=(0,Ke.up)(a,s);this.label.text=o}update(){super.update(),this.updateBillboard()}updateBillboard(){const{labelPosition:e,lineRotation:t}=this.getLinePositions(),{label:i}=this;i.setPosition(e),i.setOrientation(this.cameraData.pose.rotation,t);const{position:s,projection:a}=this.cameraData.pose,o=this.cameraData.aspect(),{height:n}=this.cameraData,r=this.cameraData.zoom(),d=(0,Le.mY)(a,s,i.position,n,Rt.Hn.SCALE),l=(0,Le.Pp)(a)?0:((0,Ot.uZ)(o,1,2.5)+r)*Rt.Hn.SCALE_ASPECT,h=1+Rt.Hn.SCALE_NDC-l,c=Math.max(Math.min(1/d*h,3),.001);i.scaleFactor=c}}class Nt extends V.Mesh{raycast(e,t){}}class Lt{constructor(e,t,i,s,a,o,n,r,d,l){this.scene=e,this.input=t,this.inputManager=i,this.editor=s,this.data=a,this.floorsViewData=o,this.cameraData=n,this.locale=r,this.engine=d,this.settingsData=l,this.currentFloorId="",this.cameraDirty=!1,this.rootObjects={},this.viewMap=new Map,this.nodeMap=new Map,this.roomMap=new Map,this.openingMap=new Map,this.visibleWallLabels=new Set,this.hideCurrentFloorViews=()=>{if(this.currentFloorId){const e=this.rootObjects[this.currentFloorId];for(const t of e.children)t instanceof ue&&this.unregisterViewToInput(t);this.scene.remove(e)}},this.showCurrentFloorViews=()=>{var e;const t=(null===(e=this.floorsViewData.singleFloor)||void 0===e?void 0:e.id)||this.floorsViewData.currentFloorId;if(t){const e=this.rootObjects[t];this.scene.add(e);for(const t of e.children)t instanceof ue&&this.registerViewToInput(t);this.currentFloorId=t}},this.updateOpeningView=(()=>{const e=new V.Vector3,t=new V.Vector3,i=new V.Vector3,s=new V.Vector3,a=new V.Vector3,o=new V.Vector3;return n=>{var r;const d=this.data.getWall(n.wallId),l=(null===(r=this.floorsViewData.floors.getFloor(d.floorId))||void 0===r?void 0:r.bottom)||0;o.set(0,l,0),d.getBiasAdjustmentVec(a),d.from.getVec3(i).add(a).add(o),d.to.getVec3(s).add(a).add(o),t.subVectors(s,i).normalize(),e.copy(i),e.lerp(s,n.relativePos),i.copy(e).addScaledVector(t,-.5*n.width),s.copy(e).addScaledVector(t,.5*n.width);const h=this.openingMap.get(n.id);if(!h)throw new Error("Unable to find view for opening while updating");h.onEdgePositionChanged(i,s,d.width,n.type)}})(),this.onMove=({target:e})=>{e&&this.toggleLabelChildrenForView(e,!0)},this.hideAllWallLabels=()=>{if(this.visibleWallLabels.size>0){for(const e of this.visibleWallLabels)e.setLabelVisible(!1);this.visibleWallLabels.clear()}},this.onMoveEnd=({target:e})=>{e&&this.toggleLabelChildrenForView(e,!1)},this.onSelect=({target:e,previous:t})=>{t&&this.toggleViewWallLabel(t,!1),this.hideAllWallLabels(),e&&this.toggleViewWallLabel(e,!0)},this.onHover=({target:e,previous:t})=>{t&&this.toggleViewWallLabel(t,!1),e&&this.toggleViewWallLabel(e,!0)},this.floorsViewData.floors.iterate((e=>{this.rootObjects[e.id]=new V.Object3D})),this.bindings=[this.data.onWallsChanged({onRemoved:e=>this.removeViewForWall(e),onUpdated:e=>this.updateWallView(e),onAdded:e=>this.makeWallView(e)}),this.data.onNodesChanged({onRemoved:e=>this.removeViewForNode(e),onUpdated:e=>this.updateNodeView(e),onAdded:e=>this.makeNodeView(e)}),this.data.onRoomsChanged({onRemoved:e=>this.removeViewForRoom(e),onUpdated:e=>this.updateRoomView(e),onAdded:e=>this.makeRoomView(e)}),this.data.onOpeningsChanged({onRemoved:e=>this.removeViewForOpening(e),onUpdated:e=>this.updateOpeningView(e),onAdded:e=>this.makeOpeningView(e)}),this.editor.subscribe(E.M.Events.Move,this.onMove),this.editor.subscribe(E.M.Events.EditConfirm,this.onMoveEnd),this.editor.subscribe(E.M.Events.SelectChange,this.onSelect),this.editor.subscribe(E.M.Events.HoverChange,this.onHover),this.engine.subscribe(yt.S,this.hideCurrentFloorViews),this.engine.subscribe(wt.P,this.showCurrentFloorViews),n.onChanged((()=>this.cameraDirty=!0)),this.settingsData.onPropertyChanged(ft.F.UnitType,(e=>{for(const e of this.data.rooms.values())this.updateRoomView(e);for(const e of this.data.walls.values())this.updateWallView(e)}))],this.bindings.forEach((e=>e.cancel())),this.labelManager=new Vt(l.tryGetProperty("assetBasePath",""),r.languageCode,n)}init(){}render(e){this.labelManager.tickAnimations(e);const t=this.cameraData.pose.pitchFactor();for(const i of[this.viewMap,this.nodeMap,this.roomMap,this.openingMap])for(const s of i.values())s.tickAnimations(e),s.setPitchFactor(t)}dispose(){}beforeRender(){this.labelManager.update(),this.cameraDirty&&(this.cameraDirty=!1,this.updateLabels())}activate(e,t={readonly:!1}){if(!t.readonly)for(const[e,t]of this.data.nodes)this.makeNodeView(t);for(const[e,t]of this.data.walls)this.makeWallView(t);for(const[e,t]of this.data.rooms)this.makeRoomView(t);for(const[e,t]of this.data.wallOpenings)this.makeOpeningView(t);this.bindings.forEach((e=>e.renew())),this.showCurrentFloorViews()}deactivate(){this.bindings.forEach((e=>e.cancel()));for(const e in this.rootObjects){const t=this.rootObjects[e];this.scene.remove(t);for(const e of t.children.slice())e instanceof ue&&(e.dispose(),this.unregisterViewToInput(e)),t.remove(e)}}getRoomBoundView(e){const t=this.viewMap.get(e)||this.nodeMap.get(e);if(t)return t;throw new Error(`View for id: ${e} doesn't exist`)}updateLabels(){for(const e of this.roomMap.values())e.updateLabelBillboard()}registerViewToInput(...e){var t;for(const i of e)(null===(t=i.parent)||void 0===t?void 0:t.parent)&&(this.input.registerMesh(i,!1),this.inputManager.addEditableEntity(i,i.roomBoundsId))}unregisterViewToInput(...e){for(const t of e)this.input.unregisterMesh(t),this.inputManager.removeEditableEntity(t.roomBoundsId)}makeNodeView(e){var t;const i=new Et(e.id,this.cameraData),s=(null===(t=this.floorsViewData.floors.getFloor(e.floorId))||void 0===t?void 0:t.bottom)||0;i.updatePosition(new V.Vector3(e.x,s,e.z)),this.nodeMap.set(e.id,i),this.rootObjects[e.floorId].add(i),this.registerViewToInput(i)}updateNodeView(e){var t;const i=this.nodeMap.get(e.id);if(i){const s=(null===(t=this.floorsViewData.floors.getFloor(e.floorId))||void 0===t?void 0:t.bottom)||0;i.updatePosition(new V.Vector3(e.x,s,e.z))}}removeViewForNode(e){const t=this.nodeMap.get(e.id);t&&(this.rootObjects[e.floorId].remove(t),this.nodeMap.delete(e.id),t.dispose(),this.unregisterViewToInput(t))}makeWallView(e){const t=this.labelManager.createWallLabel(e.floorId);t.updateDimensions(e.from.getVec3(),e.to.getVec3(),e.width,this.getUnits());const i=new mt(e.id,this.cameraData,t);this.viewMap.set(e.id,i),this.rootObjects[e.floorId].add(i),t.addTo(this.rootObjects[e.floorId]),this.updateWallView(e),t.update(),this.registerViewToInput(i)}updateWallView(e){const t=this.viewMap.get(e.id);t&&t.onEdgePositionChanged(this.data,this.floorsViewData,this.getUnits())}removeViewForWall(e){const t=this.viewMap.get(e.id);t&&(this.rootObjects[e.floorId].remove(t),t.lineLabel.removeFrom(this.rootObjects[e.floorId]),this.viewMap.delete(e.id),this.visibleWallLabels.delete(t),t.dispose(),this.unregisterViewToInput(t))}makeRoomView(e){var t;const i=this.rootObjects[e.floorId];this.roomMap.has(e.id)&&this.removeViewForRoom(e);const s=(null===(t=this.floorsViewData.floors.getFloor(e.floorId))||void 0===t?void 0:t.bottom)||0,a=new rt(e,s,this.cameraData,this.labelManager,this.getUnits());i.add(a),this.roomMap.set(e.id,a),this.registerViewToInput(a),this.updateRoomView(e)}updateRoomView(e){var t;const i=this.roomMap.get(e.id);if(!i)throw new Error("Unable to find view for room while updating.");const s=(null===(t=this.floorsViewData.floors.getFloor(e.floorId))||void 0===t?void 0:t.bottom)||0;i.updateGeo(e,s,this.getUnits()),i.updateLabelBillboard();const a=this.getUnits();let o=`${e.getArea(a)} ${a===St.M.IMPERIAL?"sq ft":"sq m"}`;o+="\n"+e.getMeasurementText(a),i.updateText((0,bt.LN)(e.id,this.locale,this.data),o)}removeViewForRoom(e){const t=this.roomMap.get(e.id);if(!t)throw new Error("Unable to find view for room while deleting.");this.rootObjects[e.floorId].remove(t),this.roomMap.delete(e.id),t.dispose(),this.input.unregisterMesh(t),this.inputManager.removeEditableEntity(e.id)}makeOpeningView(e){const t=this.data.getWall(e.wallId),i=new ze(e.id,t.floorId,this.cameraData);this.rootObjects[t.floorId].add(i,i.stencilPrepass,i.startHandle,i.endHandle),this.openingMap.set(e.id,i),this.registerViewToInput(i,i.startHandle,i.endHandle),this.updateOpeningView(e)}removeViewForOpening(e){const t=this.openingMap.get(e.id);if(!t)throw new Error("Unable to find view for opening while deleting.");this.rootObjects[t.floorId].remove(t,t.stencilPrepass,t.startHandle,t.endHandle),this.openingMap.delete(e.id),t.dispose(),this.unregisterViewToInput(t,t.startHandle,t.endHandle)}toggleLabelChildrenForView(e,t){if(this.viewMap.has(e)){const i=this.data.getWall(e);this.toggleViewWallLabel(i.to.id,t),this.toggleViewWallLabel(i.from.id,t)}else this.toggleViewWallLabel(e,t)}toggleViewWallLabel(e,t){const i=this.viewMap.get(e)||this.roomMap.get(e);if(i){const e=i.hoverState.active,s=i.selectState.active||i.highlightState.active,a=e||s||t;i.setLabelVisible(a),i instanceof mt&&(a?this.visibleWallLabels.add(i):this.visibleWallLabels.delete(i))}if(this.nodeMap.has(e)){const i=this.data.getNode(e);if(i){const e=this.data.getWallsForNode(i);for(const i of e)this.toggleViewWallLabel(i.id,t)}}}getUnits(){return this.settingsData.tryGetProperty(ft.F.UnitType,St.M.IMPERIAL)}}var Pt=i(18544),Ft=i(85893),kt=i(67294),Bt=i(33558),Wt=i(38399),Ut=i(9074),zt=i(38490),_t=i(38039),Ht=i(68072),Gt=i(65298),jt=i(66102),$t=i(1358);function qt({room:e}){const t=(0,$t.S)(),i=(0,jt.b)(),s=(0,bt.LN)(e.id,i,t);return(0,Ft.jsx)("div",Object.assign({className:"room-title"},{children:s}))}var Yt=i(65428);function Zt(){const{locale:e,commandBinder:t}=(0,kt.useContext)(Bt.I),i=(0,Yt.A)(),s=(0,Ut._)(),a=i&&(i===d.w1.SEARCH||i===d.w1.LAYERS);async function o(){a?(await t.issueCommand(new c.cR),await t.issueCommand(new c.qy(!1))):s&&t.issueCommand(new A.pZ(s.id))}const n=e.t(a?Wt.Z.SHOWCASE.ROOMS.BACK:Wt.Z.SHOWCASE.ROOMS.CLOSE),r=a?"back":"close";return(0,Ft.jsxs)(Ht.J,Object.assign({open:!!s,onClose:o},{children:[(0,Ft.jsx)("div",Object.assign({className:"detail-panel-header"},{children:(0,Ft.jsx)(zt.P,{label:n,className:"return-btn",icon:r,size:_t.qE.SMALL,onClose:o})})),(0,Ft.jsxs)("div",Object.assign({className:"room-view"},{children:[s&&(0,Ft.jsx)(qt,{room:s}),s&&(0,Ft.jsx)(Gt.M,{room:s})]}))]}))}class Kt{constructor(){}renderPanel(){return(0,Ft.jsx)(Zt,{})}}var Xt=i(40964);class Jt{constructor(e,t,i){this.engine=e,this.toolsData=t,this.viewData=i,this.bindings=[],this.selectionChanged=async e=>{if(this.toolsData.activeToolName===d.w1.ROOM_BOUNDS)return;const t=this.viewData.getSelectedRoom(e);this.toolsData.activeToolName===d.w1.ROOM_VIEW!==!!t&&(await this.engine.commandBinder.issueCommand(new c.tT(d.w1.ROOM_VIEW,!!t)),this.engine.broadcast(t?new Xt.ro:new Xt.A))},this.bindings.push(this.viewData.editorState.onPropertyChanged("selected",this.selectionChanged))}async activate(){}async deactivate(){}async dispose(){this.bindings.forEach((e=>e.cancel()))}}var Qt=i(38042),ei=i(79727),ti=i(33324),ii=i(9037);const si=.5;class ai{constructor(e){this.axis=new oi(e),this.orthoAxis=new oi(e)}showAt(e,t){this.axis.setPosition(e),this.axis.show(),t?(this.orthoAxis.setPosition(t),this.orthoAxis.show()):this.orthoAxis.hide()}hide(){this.axis.hide(),this.orthoAxis.hide()}dispose(){this.axis.dispose(),this.orthoAxis.dispose()}}class oi{constructor(e){this.scene=e,this.setPosition=(()=>{const e=new V.Vector3,t=new V.Vector3,i=new V.Vector3,s=new V.Vector3;return a=>{i.subVectors(a.end,a.start).normalize(),s.copy(i).applyAxisAngle(C.fU.UP,Math.PI/2),e.copy(a.start).addScaledVector(i,-1e3),t.copy(a.start).addScaledVector(i,1e3),this.alignedAxis.updateEndpoints(e,t),e.copy(a.start).addScaledVector(s,si),t.copy(a.start).addScaledVector(i,si).addScaledVector(s,si),this.angleIndictorLine1.updateEndpoints(e,t),e.copy(a.start).addScaledVector(s,-1e3),t.copy(a.start).addScaledVector(s,1e3),this.orthoAxis.updateEndpoints(e,t),e.copy(a.start).addScaledVector(i,si),t.copy(a.start).addScaledVector(s,si).addScaledVector(i,si),this.angleIndictorLine2.updateEndpoints(e,t)}})();const t={dashed:!1,dashSize:1,gapSize:1,lineWidth:1,color:de.I.MP_BRAND,dashUnits:dt.PIXELS,depthWrite:!1,depthTest:!1,depthFunc:V.AlwaysDepth,opacity:1},i={dashed:!0,dashSize:5,gapSize:2,lineWidth:1,color:de.I.MP_BRAND,dashUnits:dt.PIXELS,depthWrite:!1,depthTest:!1,depthFunc:V.AlwaysDepth,opacity:1};this.alignedAxis=new ct(new V.Vector3,new V.Vector3,i),this.orthoAxis=new ct(new V.Vector3,new V.Vector3,i),this.angleIndictorLine1=new ct(new V.Vector3,new V.Vector3,t),this.angleIndictorLine2=new ct(new V.Vector3,new V.Vector3,t),this.scene.add(this.alignedAxis),this.scene.add(this.orthoAxis),this.scene.add(this.angleIndictorLine1),this.scene.add(this.angleIndictorLine2),this.hide()}show(){this.alignedAxis.visible=!0,this.orthoAxis.visible=!0,this.angleIndictorLine1.visible=!0,this.angleIndictorLine2.visible=!0}hide(){this.alignedAxis.visible=!1,this.orthoAxis.visible=!1,this.angleIndictorLine1.visible=!1,this.angleIndictorLine2.visible=!1}dispose(){this.scene.remove(this.alignedAxis),this.scene.remove(this.orthoAxis),this.scene.remove(this.angleIndictorLine1),this.scene.remove(this.angleIndictorLine2)}}var ni=i(95512),ri=i(20217),di=i(61282),li=i(61864);var hi,ci=i(42147),ui=i(23254),mi=i(54244),pi=i(64918),gi=i(55450),vi=i(18596),fi=i(23037),wi=i(48011);!function(e){e[e.INACTIVE=0]="INACTIVE",e[e.ACTIVE_EDIT=1]="ACTIVE_EDIT",e[e.ACTIVE_READ_ONLY=2]="ACTIVE_READ_ONLY"}(hi||(hi={}));const yi=[d.w1.ROOM_BOUNDS,d.w1.SEARCH,d.w1.LAYERS,d.w1.ROOM_VIEW];class Si extends a.Y{constructor(){super(...arguments),this.name="room_bound",this.state=hi.INACTIVE,this.disabledAssets={[w.U]:!1,[f.s]:!1,[m.re]:!1,[v.Mp]:!1,[fi.Nj]:!1},this.disabledAssetsReadOnly={[fi.Nj]:!1},this.activate=async()=>{const e=hi.ACTIVE_EDIT;await this.tryDeactivate(e),this.state=e,this.disableUnrelatedAssets.toggle(!0),this.floorsViewData.onlyShowActiveFloor.value=!0,await(0,r.E)(this.cameraData,this.viewmodeData),await this.commandBinder.issueCommand(new S._i(S.BD.DOLLHOUSE,pi.n.FadeToBlack,this.getStartCameraPose(),gi.DEFAULT_TRANSITION_TIME/2)),await this.commandBinder.issueCommand(new ri.C({phiUpperLimitDegrees:90,phiLowerLimitDegrees:di.bp*Ze.MN,noTransition:!0})),await this.commandBinder.issueCommand(new ci.Nb),await this.commandBinder.issueCommand(new ni.y(!0)),await(0,r.E)(this.cameraData,this.viewmodeData),await this.commandBinder.issueCommand(new b.M),await this.commandBinder.issueCommand(new ti.tR),await this.commandBinder.issueCommand(new ti.TS),await this.commandBinder.issueCommand(new ri.h),this.updateCursor(),this.editor.start(),this.renderer.activate(this.engine,{readonly:!1}),this.inputManager.activate(!1)},this.activateReadOnly=async()=>{const e=hi.ACTIVE_READ_ONLY;this.state!==e&&(await this.tryDeactivate(e),this.state=e,this.disableUnrelatedAssetsReadOnly.toggle(!0),this.editor.startReadOnly(),this.renderer.activate(this.engine,{readonly:!0}),this.inputManager.activate(!0),await(0,r.E)(this.cameraData,this.viewmodeData),this.updateCursor())},this.deactivateReadOnly=async(e=hi.INACTIVE)=>{if(this.state===hi.ACTIVE_READ_ONLY){[hi.ACTIVE_EDIT,hi.INACTIVE].includes(e)&&this.editor.exit(),this.renderer.deactivate(),this.inputManager.deactivate(),this.disableUnrelatedAssetsReadOnly.toggle(!1),this.state=e}},this.deactivate=async(e=hi.INACTIVE)=>{e===hi.INACTIVE&&this.editor.exit(),this.renderer.deactivate(),this.inputManager.deactivate(),this.disableUnrelatedAssets.toggle(!1),this.snappingAxesRenderer.hide(),await this.commandBinder.issueCommand(new b.I),await this.commandBinder.issueCommand(new ri.C({noTransition:!0})),await this.commandBinder.issueCommand(new ci.qK),await this.commandBinder.issueCommand(new ti.LW),await this.commandBinder.issueCommand(new ni.y(!1)),await this.commandBinder.issueCommand(new ti.Md),await this.commandBinder.issueCommand(new p.u(g.C.DEFAULT)),this.floorsViewData.onlyShowActiveFloor.value=!1,this.state=hi.INACTIVE},this.tryDeactivate=async e=>{this.state===hi.ACTIVE_EDIT?await this.deactivate(e):this.state===hi.ACTIVE_READ_ONLY&&await this.deactivateReadOnly(e)},this.unselect=async e=>{e&&(await this.updateShowcaseVisibility(),this.state!==hi.INACTIVE&&this.editor.deselect())},this.undo=async()=>{await this.ensureValidViewMode(),this.editor.discard(),this.data.undo(),this.engine.broadcast(new wi.Lp)},this.edit=async e=>{const t=this.editor.state;t.toolState===E.M.ToolState.EDITING&&t.currentId&&this.editor.tryCommit(),this.editor.edit(e)},this.finishEdit=()=>{this.editor.tryCommit()},this.cancelEdit=async()=>{await this.ensureValidViewMode(),this.editor.discard()},this.exitEdit=()=>{this.editor.discard()},this.deleteEntity=async e=>{await this.ensureValidViewMode();const t=this.editor.state,i=e.id||t.currentId;i&&(this.engine.broadcast(new wi.z_(i)),this.editor.discard(),this.data.deleteEntity(i),this.data.finalizeHistory())},this.addEntity=async({addState:e,wallType:t})=>{await this.ensureValidViewMode();const i=this.editor.state.toolState;i!==E.M.ToolState.IDLE&&i!==E.M.ToolState.SELECTED&&this.editor.discard(),this.editor.state.addType=e,void 0!==t&&(this.editor.state.wallType=t),this.editor.waitForAdd()},this.updateCursor=()=>{this.commandBinder.issueCommand(new p.u(this.editor.state.cursor))}}async init(e,t){this.commandBinder=t.commandBinder,this.engine=t;const[i,a,r,d,h,c,m,p,g,v,f]=await Promise.all([t.getModuleBySymbol(s.PZ),t.getModuleBySymbol(s.fQ),t.market.waitForData(D.Z),t.getModuleBySymbol(s.Aj),t.market.waitForData(o.e),t.market.waitForData(ei.c),t.market.waitForData(ii.M),t.getModuleBySymbol(s.e9),t.market.waitForData(ui.O),t.market.waitForData(mi.pu),t.market.waitForData(l.t)]);this.data=r,this.floorsViewData=c,this.cameraData=m,this.viewmodeData=g,this.applicationData=v,this.toolsData=f,this.settingsData=h,this.disableUnrelatedAssets=new n.u(h,this.disabledAssets),this.disableUnrelatedAssetsReadOnly=new n.u(h,this.disabledAssetsReadOnly),this.snappingAxesRenderer=new ai(d.getScene());const w=new V.Vector3,S=()=>{var e;const t=i.getCurrentPointerRay();return w.set(0,0,0),c.currentFloor&&t.intersectPlane(null===(e=c.currentFloor)||void 0===e?void 0:e.groundPlane,w),w};this.editor=new vt(S,i,a,t.msgBus,r,this.floorsViewData,m.pose,t.commandBinder,e.rootNode);const b=h.tryGetProperty(u.gx.RoomBounds,!1);this.viewData=new Pt.e(this.data,this.editor.state,b),this.addToolPanel(),this.inputManager=new G(this.editor,S,r,m,this.snappingAxesRenderer,i.keyboardState),this.renderer=new Lt(d.getScene(),i,this.inputManager,this.editor,this.data,this.floorsViewData,m,p,t,h),t.addComponent(this,this.renderer),this.renderer.deactivate(),this.bindings.push(this.editor.subscribe(E.M.Events.CurrentChange,(({target:e})=>{this.engine.broadcast(new wi.df(e))})),this.editor.subscribe(E.M.Events.EditConfirm,(({target:e})=>{this.engine.broadcast(new wi.N2(e))})),this.editor.subscribe(E.M.Events.AddConfirm,(({target:e})=>{this.engine.broadcast(new wi.SE(e))})),t.commandBinder.addBinding(A.Yx,this.activate),t.commandBinder.addBinding(A.Rc,(async()=>this.deactivate())),t.commandBinder.addBinding(A.pZ,(async e=>this.unselect(e.id))),t.commandBinder.addBinding(A.Os,(async e=>this.toggleVisibilityForViewer(e.visible))),this.editor.state.onPropertyChanged("cursor",this.updateCursor),g.currentModeObservable.onChanged((()=>this.updateShowcaseVisibility())),this.toolsData.onPropertyChanged("activeToolName",(()=>this.updateShowcaseVisibility())),t.subscribe($.pB,(e=>{this.updateShowcaseVisibility(),e.application===mi.Mx.SHOWCASE&&this.addToolPanel()}))),e.readonly||this.bindings.push(t.commandBinder.addBinding(A.pd,(async e=>this.deleteEntity(e))),t.commandBinder.addBinding(A.o3,(async()=>this.undo())),t.commandBinder.addBinding(A.vQ,this.addEntity),t.commandBinder.addBinding(A.mB,(async e=>this.edit(e.id))),t.commandBinder.addBinding(A.DE,(async()=>this.finishEdit())),t.commandBinder.addBinding(A._j,this.cancelEdit),t.commandBinder.addBinding(A.bw,(async()=>this.exitEdit())),t.commandBinder.addBinding(A.Km,(async e=>this.editRoomData("name",e.id,e.data))),t.commandBinder.addBinding(A.c8,(async e=>this.editRoomTypes(e.id,e.data))),t.commandBinder.addBinding(A.y1,(async e=>this.editRoomData("location",e.id,e.data))),t.commandBinder.addBinding(A.hu,(async e=>this.editRoomData("includeInAreaCalc",e.id,e.data))),t.commandBinder.addBinding(A.bS,(async e=>this.editRoomData("hide",e.id,e.data))),h.onPropertyChanged(u.gx.RoomBounds,(()=>this.updateShowcaseAvailability())),h.onPropertyChanged(y.dF,(()=>this.updateShowcaseAvailability()))),t.market.register(this,Pt.e,this.viewData),this.updateShowcaseAvailability(),async function(e){const t=await e.market.waitForData(o.e),i=await e.getModuleBySymbol(li.Ak),s=(e,s,a)=>{i.registerSetting("Room Bounds"+e,e+s+"Inner",a.innerColor,!0),t.onPropertyChanged(e+s+"Inner",(e=>a.innerColor=e)),i.registerSetting("Room Bounds"+e,e+s+"Outer",a.outerColor,!0),t.onPropertyChanged(e+s+"Outer",(e=>a.outerColor=e)),i.registerSetting("Room Bounds"+e,e+s+"Opacity",a.opacity,!0),t.onPropertyChanged(e+s+"Opacity",(e=>a.opacity=e))},a=(e,t)=>{s(e,"Base",t.baseState),s(e,"Hover",t.hoverState),s(e,"Select",t.selectState),s(e,"Dim",t.dimState)};a("Node",Pe),a("Edge",ut),a("Room",nt),i.registerButton("Room Bounds Export","Export colors",(()=>{const e={Node:Pe,Edge:ut,Room:nt},t=JSON.stringify(e);navigator.clipboard.writeText(t)})),i.registerButton("Room Bounds Export","Import colors",(async()=>{const e=(e,t,i)=>{s(e.baseState,t.baseState,i,"Base"),s(e.hoverState,t.hoverState,i,"Hover"),s(e.selectState,t.selectState,i,"Select"),s(e.dimState,t.dimState,i,"Dim")},s=(e,t,s,a)=>{e.innerColor=new V.Color(t.innerColor),e.outerColor=new V.Color(t.outerColor),e.opacity=t.opacity;const o=s+a;i.updateSetting(o+"Inner",e.innerColor),i.updateSetting(o+"Outer",e.outerColor),i.updateSetting(o+"Opacity",e.opacity)},a=await navigator.clipboard.readText(),o=JSON.parse(a);o&&(e(Pe,o.Node,"Node"),e(ut,o.Edge,"Edge"),e(nt,o.Room,"Room")),t.setDirty(!0),t.commit()}))}(t)}dispose(e){super.dispose(e),e.market.unregister(this,Pt.e)}toggleVisibilityForViewer(e){this.viewData.visibleInShowcase=e,this.viewData.commit(),this.updateShowcaseVisibility()}async updateShowcaseAvailability(){const e=this.settingsData.tryGetProperty(u.gx.RoomBounds,!1),t=this.settingsData.tryGetProperty(y.dF,!1),i=e&&t;this.settingsData.setProperty(I.hW,i),i&&!this.viewData.visibleInShowcase?this.toggleVisibilityForViewer(!0):this.updateShowcaseVisibility()}async updateShowcaseVisibility(){const{application:e}=this.applicationData,t=e===mi.Mx.SHOWCASE,i=e===mi.Mx.WORKSHOP,s=this.settingsData.tryGetProperty(I.hW,!1),a=t&&this.viewData.visibleInShowcase&&s||i,o=null==this.toolsData.activeToolName||yi.includes(this.toolsData.activeToolName),n=this.viewmodeData.isFloorplan(),r=this.data.rooms.size>0;a&&n&&o&&r?await this.activateReadOnly():await this.deactivateReadOnly()}async addToolPanel(){if(!this.toolsData.getTool(d.w1.ROOM_VIEW)){const e=new Jt(this.engine,this.toolsData,this.viewData),t=new h.U({id:d.w1.ROOM_VIEW,panel:!0,enabled:!0,dimmed:!1,manager:e,ui:new Kt,analytic:"rooms"});await this.engine.commandBinder.issueCommand(new c.MV([t]))}}editRoomData(e,t,i){this.data.getRoom(t)[e]!==i&&(this.data.setRoomDetails(t,{[e]:i}),this.data.finalizeHistory())}editRoomTypes(e,t){const i=this.data.getRoom(e).classifications.map((e=>e.id));if(!(0,Qt.E8)(t,i)){const i=t.map((e=>this.data.roomClassifications[e])),{location:s,includeInAreaCalc:a,hide:o,keywords:n}=(0,z.Ci)((0,z.Hc)(i));this.data.setRoomDetails(e,{roomTypeIds:t,location:s,includeInAreaCalc:a,hide:o,keywords:n}),this.data.finalizeHistory()}}getStartCameraPose(){const e=this.floorsViewData.currentFloor||this.floorsViewData.getFloor(this.floorsViewData.bottomFloorId),t=e.bottom,i=e.boundingBox.getCenter(new V.Vector3);i.y=t;const s=e.boundingBox.max.clone();s.y=t;const a=i.distanceTo(s)/Math.tan(vi.oR.fov/2*Ze.Ue),o=C.Hk.DOWNWARD.clone().multiply((new V.Quaternion).setFromAxisAngle(C.fU.RIGHT,45*Ze.Ue)),n=C.fU.FORWARD.clone().applyQuaternion(o).multiplyScalar(-1*a);return{position:i.clone().add(n),rotation:o}}async ensureValidViewMode(){this.cameraData.pose.autoOrthoApplied&&await this.engine.commandBinder.issueCommand(new ri.h)}}},48011:(e,t,i)=>{"use strict";i.d(t,{Lp:()=>o,N2:()=>d,SE:()=>n,df:()=>l,z_:()=>r});var s=i(98010);class a extends s.v0{constructor(e){super(),this.target=e}}class o extends a{}class n extends a{}class r extends a{}class d extends a{}class l extends a{}},20241:(e,t,i)=>{"use strict";i.d(t,{d:()=>s});class s{constructor(e){this.tags=[],e&&Object.assign(this,e)}}},56163:(e,t,i)=>{"use strict";i.d(t,{K:()=>r});var s=i(52528),a=i(71166),o=i(63319);const n=new s.v({});class r{constructor(e,t,i){this.commandBinder=e,this.layersData=t,this.dataTypeGroup=i,this.textParser=n,this.enabled=!0,this.bindings=[]}getGroupingId(e){switch(e){case o.HH.TYPE:return this.getTypeId();case o.HH.FLOOR:return this.getFloorId();case o.HH.ROOM:return this.getRoomId();case o.HH.LAYER:return this.getLayerGroupId();case o.HH.DATE:return this.dateBucket}}getFloorId(){return this.floorId}getRoomId(){return this.roomId}getDateBucket(){return this.dateBucket}getTypeId(){return this.typeId}supportsBatchDelete(){return!1}supportsLayeredCopyMove(){return!1}getLayerGroupId(){var e,t;const i=null===(e=this.layersData)||void 0===e?void 0:e.getBaseLayerId(),s=null===(t=this.layersData)||void 0===t?void 0:t.getViewLayerId();return this.layerId&&s&&this.layerId===i?s:this.layerId}isLayerVisible(){return!this.layersData||!this.layerId||this.layersData.layerVisible(this.layerId)}onSelect(e,t,i){this.commandBinder.issueCommand(new a.IL(this.id,this.typeId))}registerBindings(){}cancelBindings(){this.bindings.forEach((e=>e.cancel()))}}},94046:(e,t,i)=>{"use strict";i.d(t,{i:()=>a});var s=i(81396);class a extends s.Mesh{}},83402:(e,t,i)=>{"use strict";i.d(t,{l1:()=>n,r2:()=>l});var s=i(81396),a=i(69505),o=i(90304);var n;!function(e){e[e.Axes=1]="Axes",e[e.PlanarAxes=2]="PlanarAxes",e[e.EdgesAndPlanarAxes=3]="EdgesAndPlanarAxes",e[e.Edges=4]="Edges",e[e.Free=5]="Free",e[e.Locked=6]="Locked"}(n||(n={}));const r={[o.eD.UP]:{dir:Object.freeze(o.fU.UP.clone())},[o.eD.DOWN]:{dir:Object.freeze(o.fU.DOWN.clone())},[o.eD.BACK]:{dir:Object.freeze(o.fU.BACK.clone())},[o.eD.LEFT]:{dir:Object.freeze(o.fU.LEFT.clone())},[o.eD.RIGHT]:{dir:Object.freeze(o.fU.RIGHT.clone())},[o.eD.FORWARD]:{dir:Object.freeze(o.fU.FORWARD.clone())}},d={[o.eD.HORIZONTAL_PLANE]:{dir:Object.freeze(o.fU.HORIZONTAL_PLANE.clone())}},l=(()=>{let e=0;const t=new s.Vector3,i=new s.Vector3,l=new s.Vector3,h=new s.Vector3,c=999,u=Object.freeze(o.fU.ZERO.clone()),m=Object.keys(r).map((e=>Object.assign(Object.assign({},r[e]),{name:e,angleTo:c}))),p=Object.keys(d).map((e=>Object.assign(Object.assign({},d[e]),{name:e,angleTo:c}))),g=e=>(e+3)%2;let v=m[0];return(s,r,d=n.Axes)=>{if(d===n.Free)return{position:r.clone(),constrainedAxis:u,axisName:o.eD.NONE};if(m.forEach((e=>e.angleTo=c)),p.forEach((e=>e.angleTo=c)),l.copy(r).sub(s),e=l.length(),e<.05)return{position:r.clone(),constrainedAxis:u,axisName:o.eD.NONE};h.copy(l).normalize();const f=.05*Math.min(e,1);if(d!==n.Locked){for(const e of m){const t=(0,a.ZY)(h.angleTo(e.dir));t<v.angleTo&&(v=e),e.angleTo=t}if(v.angleTo>20){const e=Math.abs(l.y);e*e<f&&(v=p[0])}}t.set(s.x*g(v.dir.x),s.y*g(v.dir.y),s.z*g(v.dir.z)),i.set(r.x*Math.abs(v.dir.x),r.y*Math.abs(v.dir.y),r.z*Math.abs(v.dir.z)).add(t);return d===n.Locked||i.distanceToSquared(r)<f?{position:i.clone(),constrainedAxis:v.dir,axisName:v.name}:{position:r.clone(),constrainedAxis:u,axisName:o.eD.NONE}}})()},10513:(e,t,i)=>{"use strict";i.d(t,{M:()=>c});var s=i(75287),a=i(89570),o=i(2224),n=i(97998),r=i(37082),d=i(13693),l=i(98010);const h=new n.Z("editor");var c;!function(e){let t,i;e.DragAndDrop=class{constructor(e=new n){this.state=e,this.events=new d.Y,this.bindings=[],this.validator=null,this.state.commit(),this.bindings.push(this.state.onPropertyChanged("toolState",(()=>{h.debug("toolState:",{from:this.state.previousToolState,to:this.state.toolState},this.state),this.events.broadcast(new i.StateChange(this.state.toolState,this.state.previousToolState))})),this.onSelectedChanged(((e,t)=>{this.events.broadcast(new i.SelectChange(e,t))})),this.onHoveredChanged(((e,t)=>{this.events.broadcast(new i.HoverChange(e,t))})),this.state.onCurrentIdChanged(((e,t)=>{this.events.broadcast(new i.CurrentChange(e,t))}))),this.bindings.forEach((e=>e.cancel()))}subscribe(e,t){return this.events.subscribe(e,t)}setState(e){e!==this.state.toolState&&(this.state.previousToolState=this.state.toolState,this.state.toolState=e,this.state.commit())}start(){const{toolState:e}=this.state;if(e===t.CLOSED)this.bindings.forEach((e=>e.renew()));else if(e!==t.READ_ONLY)throw new c("Editor already started");this.setState(t.IDLE),this.events.broadcast(new i.Start)}startReadOnly(){const{toolState:e}=this.state;if(e===t.CLOSED)this.bindings.forEach((e=>e.renew()));else if(e!==t.IDLE)throw new c("Editor already started");this.setState(t.READ_ONLY)}setEnabled(e){if(this.state.toolState===t.CLOSED)throw new c("Editor not started");if(e)this.state.toolState===t.DISABLED&&this.setState(t.IDLE);else switch(this.state.toolState){case t.DISABLED:break;case t.IDLE:this.setState(t.DISABLED);break;default:this.unhover({commit:!1}),this.deselect({commit:!1}),this.discard(),this.setState(t.DISABLED)}}exit(){this.state.toolState!==t.CLOSED&&(this.state.toolState!==t.DISABLED&&(this.unhover({commit:!1}),this.deselect({commit:!1}),this.discard()),this.setState(t.CLOSED),this.bindings.forEach((e=>e.cancel())),this.events.broadcast(new i.Exit))}setValidator(e){this.validator=e}onDiscard(e){this.state.onBeforeDiscard=e||null}edit(e){if(this.assertActive(),null!==this.state.pendingEdit)throw h.error(`Trying to edit asset ${e}, but currently editing ${this.state.pendingEdit}`),new c("Edit in progress");this.state.pendingEdit=e,this.setState(t.EDITING),this.events.broadcast(new i.EditStart(e,!1))}waitForAdd(){if(this.assertActive(),null!==this.state.pendingAdd)throw h.error(`Entering wait for add state, but already adding ${this.state.pendingAdd}`),new c("Add in progress");null!==this.state.selected&&(h.debug(`Entering the wait for add state, deselecting previous ${this.state.selected}`),this.deselect({commit:!1})),this.events.broadcast(new i.WaitForAddStart),this.setState(t.WAIT_FOR_ADD)}add(e){if(this.assertActive(),null!==this.state.pendingAdd)throw h.error(`Trying to add new asset ${e}, but already adding ${this.state.pendingAdd}`),new c("Add in progress");null!==this.state.selected&&(h.debug(`Add ${e} called, deselecting previous ${this.state.selected}`),this.deselect({commit:!1})),this.state.pendingAdd=e,this.events.broadcast(new i.AddStart(e)),this.setState(t.ADDING)}place(e){this.assertActive();const{pendingAdd:s,pendingEdit:a}=this.state,o=s||a;o&&e===o||(this.state.pendingEdit=e),this.setState(t.PLACING),this.events.broadcast(new i.EditStart(e,!0))}move(e){this.assertActive(),this.validate(e);const{pendingAdd:t,pendingEdit:s,selected:a}=this.state,o=t||s||a;o&&this.events.broadcast(new i.Move(o,e)),this.state.ndcPosition.value=e.clientPosition}highlight(...e){this.assertActive();for(const t of e)this.state.highlighted.add(t),this.events.broadcast(new i.HighlightAdd(t))}clearAllHighlights(){this.assertActive();for(const e of this.state.highlighted)this.events.broadcast(new i.HighlightClear(e));this.state.highlighted.clear()}dim(e){this.assertActive(),this.state.dimmed.add(e),this.events.broadcast(new i.DimAdd(e))}clearDim(e){this.assertActive(),this.state.dimmed.delete(e),this.events.broadcast(new i.DimClear(e))}clearAllDims(){this.assertActive();for(const e of this.state.dimmed)this.events.broadcast(new i.DimClear(e));this.state.dimmed.clear()}select(e,i){this.assertActive(),this.state.pendingAdd||this.state.pendingEdit||(this.state.previousSelected=this.state.selected,this.state.selected=e,this.state.commit(),i&&i.transitionTo?this.setState(i.transitionTo):this.state.isReadonly()?this.setState(t.SELECTED_READ_ONLY):this.setState(t.SELECTED))}toggleSelect(e){this.state.selected===e?this.deselect():this.select(e)}deselect(e={commit:!0}){this.assertActive(),this.state.pendingAdd||this.state.pendingEdit||null!==this.state.selected&&(this.state.previousSelected=this.state.selected,this.state.selected=null,e.commit&&this.state.commit(),e&&e.transitionTo?this.setState(e.transitionTo):this.state.toolState===t.SELECTED_READ_ONLY?this.setState(t.READ_ONLY):this.setState(t.IDLE))}hover(e){this.assertActive(),e!==this.state.hovered&&(this.state.previousHovered=this.state.hovered,this.state.hovered=e,this.state.commit())}unhover(e={commit:!0}){this.state.hovered&&(this.state.previousHovered=this.state.hovered,this.state.hovered=null,e.commit&&this.state.commit())}tryCommit(){this.assertActive();const e=this.state.pendingAdd,t=this.state.pendingEdit;if(!1===this.state.pendingValid)return h.warn("nop, pendingValid",this.state.pendingValid),!1;let s=!1;const a=this.state.selected,o=this.state.pendingAdd||this.state.pendingEdit;if(o){const n=null===this.state.pendingValid||!0===this.state.pendingValid;n&&(this.state.pendingAdd=null,this.state.pendingEdit=null,this.state.pendingValid=null,this.state.onBeforeDiscard=null,t&&this.events.broadcast(new i.EditConfirm(t)),e&&this.events.broadcast(new i.AddConfirm(e)),this.state.pendingAdd||this.state.pendingEdit||a!==this.state.selected||this.select(o)),s=n}return s}discard(){const s=this.state.pendingAdd||this.state.pendingEdit,a=this.state.pendingAdd,o=this.state.pendingEdit;s&&(this.state.onBeforeDiscard&&this.state.onBeforeDiscard(),o&&(this.state.pendingEdit=null,this.events.broadcast(new i.EditDiscard(o))),a&&(this.state.pendingAdd=null,this.events.broadcast(new i.AddDiscard(a))),this.events.broadcast(new e.Events.ValidChange(null,null)),this.state.pendingValid=null,this.state.onBeforeDiscard=null),this.unhover({commit:!1}),this.deselect({commit:!1}),this.state.isReadonly()?this.setState(t.READ_ONLY):this.state.toolState!==t.IDLE&&this.setState(t.IDLE),this.state.commit()}validate(t){const i=this.state.pendingAdd||this.state.pendingEdit||this.state.selected;if(i){const s=this.state.pendingValid;let a=!0;this.validator?(a=this.validator.validate(i,t),this.state.pendingValid=a):this.state.pendingValid=null,null!==this.state.pendingValid&&s!==this.state.pendingValid&&this.events.broadcast(new e.Events.ValidChange(a?i:null,a?null:i))}}assertActive(){if(this.state.toolState===e.ToolState.CLOSED)throw new c("Editor closed");if(this.state.toolState===e.ToolState.DISABLED)throw new c("Editor disabled")}onSelectedChanged(e){return this.state.onPropertyChanged("selected",(()=>e(this.state.selected,this.state.previousSelected)))}onHoveredChanged(e){return this.state.onPropertyChanged("hovered",(()=>e(this.state.hovered,this.state.previousHovered)))}},function(e){e.CLOSED="CLOSED",e.READ_ONLY="READ_ONLY",e.DISABLED="DISABLED",e.IDLE="IDLE",e.SELECTED="SELECTED",e.SELECTED_READ_ONLY="SELECTED_READ_ONLY",e.WAIT_FOR_ADD="WAIT_FOR_ADD",e.ADDING="ADDING",e.EDITING="EDITING",e.PLACING="PLACING"}(t=e.ToolState||(e.ToolState={}));class n extends s.T{constructor(){super(...arguments),this.toolState=t.CLOSED,this.previousToolState=t.CLOSED,this.pendingAdd=null,this.pendingEdit=null,this.selected=null,this.previousSelected=null,this.hovered=null,this.previousHovered=null,this.highlighted=new Set,this.dimmed=new Set,this.ndcPosition=new r.f(null),this.onBeforeDiscard=null,this.pendingValid=null}get currentId(){return this.pendingAdd||this.pendingEdit||this.selected||null}onCurrentIdChanged(e,t=!1){let i=this.currentId;const s=()=>{this.currentId!==i&&(e(this.currentId,i),i=this.currentId)},o=new a.V(this.onPropertyChanged("selected",s),this.onPropertyChanged("pendingAdd",s),this.onPropertyChanged("pendingEdit",s));return t?o.renew():o.cancel(),o}isReadonly(){return this.toolState===t.READ_ONLY||this.toolState===t.SELECTED_READ_ONLY}}e.State=n;class c extends o.y{constructor(e="invalid state"){super(e),this.name="invalid state"}}e.EditorException=c,function(e){class t extends l.v0{}t.type="edit",e.EditEvent=t;class i extends t{constructor(e){super(),this.target=e}}i.type="editt",e.EditTarget=i;class s extends t{constructor(e,t){super(),this.target=e,this.previous=t}}s.type="edittp",e.EditTargetAndPrev=s;class a extends t{constructor(e,t){super(),this.target=e,this.previous=t}}a.type="toolchange",e.StateChange=a;class o extends t{}o.type="editorstart",e.Start=o;class n extends t{}n.type="editorexit",e.Exit=n;class r extends t{}r.type="waitforaddstart",e.WaitForAddStart=r;class d extends i{}d.type="addstart",e.AddStart=d;class h extends i{constructor(e,t){super(e),this.placeOnly=t}}h.type="editstart",e.EditStart=h;class c extends i{}c.type="addconfirm",e.AddConfirm=c;class u extends i{}u.type="adddiscard",e.AddDiscard=u;class m extends i{}m.type="editconfirm",e.EditConfirm=m;class p extends i{}p.type="editdiscard",e.EditDiscard=p;class g extends i{}g.type="delete",e.Delete=g;class v extends i{constructor(e,t){super(e),this.target=e,this.ev=t}}v.type="move",e.Move=v;class f extends s{}f.type="target",e.CurrentChange=f;class w extends s{}w.type="hover",e.HoverChange=w;class y extends s{}y.type="select",e.SelectChange=y;class S extends i{}S.type="highlight",e.HighlightAdd=S;class b extends i{}b.type="highlightclear",e.HighlightClear=b;class E extends i{}E.type="dim",e.DimAdd=E;class D extends i{}D.type="dimclear",e.DimClear=D;class I extends s{}I.type="valid",e.ValidChange=I,e.hasTarget=function(e){return e instanceof i},e.hasTargetAndPrev=function(e){return e instanceof s}}(i=e.Events||(e.Events={}))}(c||(c={}))},44724:e=>{e.exports="precision highp float;precision highp int;uniform mat4 viewMatrix;uniform vec3 cameraPosition;uniform float opacity;uniform vec3 color;uniform sampler2D bg;varying vec2 vUv;void main(){vec4 bgColor=texture2D(bg,vUv);gl_FragColor=vec4(bgColor.rgb,bgColor.a*opacity);}"},52059:e=>{e.exports="precision highp float;precision highp int;uniform mat4 viewMatrix;uniform vec3 cameraPosition;uniform vec3 diffuse;uniform float opacity;uniform sampler2D mask;\n#ifdef USE_DASH\nuniform float dashSize;uniform float gapSize;\n#endif\nvarying float vLineDistance;\n#include <common>\nvarying vec2 vUv;void main(){\n#ifdef USE_DASH\nif(vUv.y<-1.||vUv.y>1.)discard;if(mod(vLineDistance,dashSize+gapSize)>dashSize)discard;\n#endif\n#ifdef USE_MASK\nvec2 modUv=vec2(vUv);modUv*=2.;vec4 texelColor=texture2D(mask,modUv);gl_FragColor=vec4(texelColor.rgb,min(texelColor.a,opacity));\n#else\ngl_FragColor=vec4(diffuse,opacity);\n#endif\n}"},7188:e=>{e.exports="precision highp float;precision highp int;uniform mat4 modelMatrix;uniform mat4 modelViewMatrix;uniform mat4 projectionMatrix;uniform mat4 viewMatrix;uniform mat3 normalMatrix;uniform vec3 cameraPosition;attribute vec3 position;attribute vec3 normal;attribute vec2 uv;\n#include <common>\nuniform float linewidth;uniform vec2 resolution;attribute vec3 instanceStart;attribute vec3 instanceEnd;attribute vec3 instanceColorStart;attribute vec3 instanceColorEnd;varying vec2 vUv;\n#ifdef USE_DASH\nuniform float dashScale;attribute float instanceDistanceStart;attribute float instanceDistanceEnd;varying float vLineDistance;\n#endif\nvoid trimSegment(const in vec4 start,inout vec4 end){float a=projectionMatrix[2][2];float b=projectionMatrix[3][2];float nearEstimate=-0.5*b/a;float alpha=(nearEstimate-start.z)/(end.z-start.z);end.xyz=mix(start.xyz,end.xyz,alpha);}void main(){\n#ifdef USE_COLOR\nvColor.xyz=(position.y<0.5)?instanceColorStart:instanceColorEnd;\n#endif\n#ifdef USE_DASH\nvLineDistance=(position.y<0.5)?dashScale*instanceDistanceStart:dashScale*instanceDistanceEnd;\n#endif\nfloat aspect=resolution.x/resolution.y;vUv=uv;vec4 start=modelViewMatrix*vec4(instanceStart,1.);vec4 end=modelViewMatrix*vec4(instanceEnd,1.);bool perspective=(projectionMatrix[2][3]==-1.);if(perspective){if(start.z<0.&&end.z>=0.){trimSegment(start,end);}else if(end.z<0.&&start.z>=0.){trimSegment(end,start);}}vec4 clipStart=projectionMatrix*start;vec4 clipEnd=projectionMatrix*end;vec2 ndcStart=clipStart.xy/clipStart.w;vec2 ndcEnd=clipEnd.xy/clipEnd.w;vec2 dir=ndcEnd-ndcStart;dir.x*=aspect;dir=normalize(dir);vec2 offset=vec2(dir.y,-dir.x);dir.x/=aspect;offset.x/=aspect;if(position.x<0.)offset*=-1.;offset*=linewidth;offset/=resolution.y;vec4 clip=(position.y<0.5)?clipStart:clipEnd;\n#ifdef USE_MASK\noffset*=(clipEnd.w+clipStart.w)*0.5;\n#else\noffset*=clip.w;\n#endif\nclip.xy+=offset;gl_Position=clip;\n#include <worldpos_vertex>\n}"},56449:e=>{e.exports="precision highp float;uniform vec3 color;uniform float antialiasWidth;uniform float lineWidth;uniform float dashed;uniform float dashSize;uniform float gapSize;uniform float opacity;varying float vDistanceFromAxis;varying float vDistanceAlong;void main(){float halfWidth=lineWidth*0.5;float antialiasing=1.-smoothstep(halfWidth,halfWidth+antialiasWidth,vDistanceFromAxis);float dashOpacity=1.;if(dashed>0.){\n#ifdef WORLDSPACE_DASH\nfloat dashAA=fwidth(vDistanceAlong)*antialiasWidth*0.5;\n#else\nfloat dashAA=antialiasWidth*0.5;\n#endif\nfloat dashT=mod(vDistanceAlong,dashSize+gapSize);dashOpacity=smoothstep(0.,dashAA,dashT)*(1.-smoothstep(dashSize-dashAA,dashSize,dashT));}gl_FragColor=vec4(color,opacity*dashOpacity*antialiasing);}"},75215:e=>{e.exports="precision highp float;uniform vec3 start;uniform vec3 end;uniform float lineWidth;uniform float antialiasWidth;uniform vec2 screenSize;uniform mat4 projectionMatrix;uniform mat4 modelViewMatrix;attribute float offsetDirection;attribute float t;varying float vDistanceFromAxis;varying float vDistanceAlong;vec2 rotate90(vec2 v){return vec2(-v.y,v.x);}vec2 ndcToScreen(vec4 pt){return pt.xy*screenSize/2.;}vec2 screenToNdc(vec2 pt){return pt*2./screenSize;}void main(){vec4 startNdc=projectionMatrix*modelViewMatrix*vec4(start,1.);vec4 endNdc=projectionMatrix*modelViewMatrix*vec4(end,1.);float z=mix(startNdc.z,endNdc.z,t);float w=mix(startNdc.w,endNdc.w,t);vec2 startScreen=ndcToScreen(startNdc/startNdc.w);vec2 endScreen=ndcToScreen(endNdc/endNdc.w);float halfWidth=lineWidth*0.5+antialiasWidth;vec2 directionScreen=endScreen-startScreen;vec2 widthOffsetScreen=rotate90(normalize(directionScreen))*offsetDirection*halfWidth;vec2 position=startScreen+directionScreen*t+widthOffsetScreen;vDistanceFromAxis=length(widthOffsetScreen);\n#ifdef WORLDSPACE_DASH\nvDistanceAlong=length((end-start)*t);\n#else\nvDistanceAlong=length(directionScreen*t);\n#endif\nvec2 posNdc=screenToNdc(position);gl_Position=vec4(posNdc*w,z,w);}"},5311:e=>{e.exports="precision highp float;uniform float opacity;uniform float centerSpacing;uniform float radius;uniform vec3 color;void main(){vec2 center=mod(gl_FragCoord.xy,vec2(centerSpacing))-vec2(centerSpacing*0.5);float polkaDot=1.-smoothstep(radius-(radius*0.2),radius,length(center));gl_FragColor=vec4(color,opacity*polkaDot);}"},26274:e=>{e.exports="precision highp float;uniform mat4 projectionMatrix;uniform mat4 modelViewMatrix;attribute vec3 position;void main(){gl_Position=projectionMatrix*modelViewMatrix*vec4(position,1.);}"},4014:e=>{e.exports="#define ANTIALIAS_WIDTH  1.0\nprecision highp float;uniform vec3 outlineColor;uniform vec3 baseColor;uniform float radius;uniform float opacity;uniform float outlinePct;varying vec3 vPosition;void main(){float fragRadius=length(vPosition.xz);float outlineRadius=radius*outlinePct;float smoothAmt=fwidth(fragRadius)*ANTIALIAS_WIDTH;float mixAmt=smoothstep(outlineRadius-smoothAmt,outlineRadius,fragRadius);gl_FragColor=vec4(mix(baseColor,outlineColor,mixAmt),1.);gl_FragColor.a=opacity*(1.-smoothstep(radius-smoothAmt,radius,fragRadius));}"},57216:e=>{e.exports="precision highp float;uniform mat4 projectionMatrix;uniform mat4 modelViewMatrix;attribute vec3 position;varying vec3 vPosition;void main(){vPosition=position;gl_Position=projectionMatrix*modelViewMatrix*vec4(position,1.);}"},73403:e=>{e.exports="precision highp float;uniform vec3 baseColor;uniform float isDoor;varying vec3 vPosition;void main(){const float lineWidth=0.15;if(isDoor>0.){const float startZ=0.15;const float endZ=startZ+lineWidth;float alpha=(abs(vPosition.z)>startZ&&abs(vPosition.z)<endZ)?1.:0.;gl_FragColor=vec4(baseColor,alpha);}else{float alpha=(abs(vPosition.z)<lineWidth*0.5)?1.:0.;gl_FragColor=vec4(baseColor,alpha);}}"},27706:e=>{e.exports="precision highp float;uniform mat4 projectionMatrix;uniform mat4 modelViewMatrix;attribute vec3 position;varying vec3 vPosition;void main(){vPosition=position;gl_Position=projectionMatrix*modelViewMatrix*vec4(position,1.);}"},56413:e=>{e.exports="#define ANTIALIAS_WIDTH  1.0\nprecision highp float;uniform float selectedWidth;uniform vec3 outlineColor;uniform vec3 color;uniform float opacity;uniform float width;uniform vec3 lineStart;uniform vec3 lineEnd;varying vec3 vWorldPos;float distanceBetween(vec2 l1,vec2 l2,vec2 p){float D=length(l2-l1);float N=abs((l2.x-l1.x)*(l1.y-p.y)-(l1.x-p.x)*(l2.y-l1.y));return N/D;}void main(){float distanceToLine=distanceBetween(lineStart.xz,lineEnd.xz,vWorldPos.xz);float aaWidth=fwidth(distanceToLine)*ANTIALIAS_WIDTH;float lineLerp=smoothstep(selectedWidth-aaWidth,selectedWidth,distanceToLine);float halfWidth=width*0.5;float aaOpacity=smoothstep(halfWidth,halfWidth-aaWidth,distanceToLine);gl_FragColor=mix(vec4(outlineColor,opacity*aaOpacity),vec4(color,opacity*aaOpacity),lineLerp);if(gl_FragColor.a<0.01){discard;}}"},33057:e=>{e.exports="precision highp float;uniform mat4 projectionMatrix;uniform mat4 modelViewMatrix;attribute vec3 position;varying vec3 vWorldPos;void main(){vWorldPos=position;gl_Position=projectionMatrix*modelViewMatrix*vec4(position,1.);}"},22999:e=>{var t={kind:"Document",definitions:[{kind:"OperationDefinition",operation:"query",name:{kind:"Name",value:"GetRoomBounds"},variableDefinitions:[{kind:"VariableDefinition",variable:{kind:"Variable",name:{kind:"Name",value:"modelId"}},type:{kind:"NonNullType",type:{kind:"NamedType",name:{kind:"Name",value:"ID"}}},directives:[]}],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"model"},arguments:[{kind:"Argument",name:{kind:"Name",value:"id"},value:{kind:"Variable",name:{kind:"Name",value:"modelId"}}}],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"floors"},arguments:[],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"id"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"layer"},arguments:[],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"id"},arguments:[],directives:[]}]}},{kind:"Field",name:{kind:"Name",value:"vertices"},arguments:[{kind:"Argument",name:{kind:"Name",value:"includeUsed"},value:{kind:"BooleanValue",value:!0}}],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"id"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"layer"},arguments:[],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"id"},arguments:[],directives:[]}]}},{kind:"Field",name:{kind:"Name",value:"position"},arguments:[],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"x"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"y"},arguments:[],directives:[]}]}}]}},{kind:"Field",name:{kind:"Name",value:"edges"},arguments:[{kind:"Argument",name:{kind:"Name",value:"includeUsed"},value:{kind:"BooleanValue",value:!0}}],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"id"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"layer"},arguments:[],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"id"},arguments:[],directives:[]}]}},{kind:"Field",name:{kind:"Name",value:"type"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"vertices"},arguments:[],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"id"},arguments:[],directives:[]}]}},{kind:"Field",name:{kind:"Name",value:"centerLineBias"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"thickness"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"openings"},arguments:[],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"id"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"width"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"relativeCenter"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"type"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"height"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"lowerElevation"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"layer"},arguments:[],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"id"},arguments:[],directives:[]}]}}]}}]}}]}},{kind:"Field",name:{kind:"Name",value:"rooms"},arguments:[],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"id"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"layer"},arguments:[],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"id"},arguments:[],directives:[]}]}},{kind:"Field",name:{kind:"Name",value:"floor"},arguments:[],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"id"},arguments:[],directives:[]}]}},{kind:"Field",name:{kind:"Name",value:"classifications"},arguments:[],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"id"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"confidence"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"label"},arguments:[],directives:[]}]}},{kind:"Field",name:{kind:"Name",value:"boundary"},arguments:[],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"edges"},arguments:[],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"id"},arguments:[],directives:[]}]}}]}},{kind:"Field",name:{kind:"Name",value:"holes"},arguments:[],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"edges"},arguments:[],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"id"},arguments:[],directives:[]}]}}]}},{kind:"Field",name:{kind:"Name",value:"dimensionEstimates"},arguments:[],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"area"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"areaIndoor"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"width"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"depth"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"units"},arguments:[],directives:[]}]}},{kind:"Field",name:{kind:"Name",value:"label"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"keywords"},arguments:[],directives:[]}]}}]}}]}},{kind:"OperationDefinition",operation:"query",name:{kind:"Name",value:"GetRoomClassifications"},variableDefinitions:[],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"roomClassifications"},arguments:[],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"id"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"label"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"defaultKeywords"},arguments:[],directives:[]}]}}]}}],loc:{start:0,end:1022}};t.loc.source={body:"query GetRoomBounds($modelId: ID!) {\n  model(id: $modelId) {\n    floors {\n      id\n      layer { id }\n      vertices(includeUsed: true) {\n        id\n        layer { id }\n        position {\n          x\n          y\n        }\n      }\n      edges(includeUsed: true) {\n        id\n        layer { id }\n        type\n        vertices { id }\n        centerLineBias\n        thickness\n        openings {\n          id\n          width\n          relativeCenter\n          type\n          height\n          lowerElevation\n          layer { id }\n        }\n      }\n    }\n    rooms {\n      id\n      layer { id }\n      floor { id }\n      classifications {\n        id\n        confidence\n        label\n      }\n      boundary {\n        edges { id }\n      }\n      holes {\n        edges { id }\n      }\n      dimensionEstimates {\n        area\n        areaIndoor\n        width\n        depth\n        units\n      }\n      label\n      keywords\n    }\n  }\n}\n\nquery GetRoomClassifications {\n   roomClassifications {\n    id\n    label\n    defaultKeywords\n  }\n}",name:"GraphQL request",locationOffset:{line:1,column:1}};function i(e,t){if("FragmentSpread"===e.kind)t.add(e.name.value);else if("VariableDefinition"===e.kind){var s=e.type;"NamedType"===s.kind&&t.add(s.name.value)}e.selectionSet&&e.selectionSet.selections.forEach((function(e){i(e,t)})),e.variableDefinitions&&e.variableDefinitions.forEach((function(e){i(e,t)})),e.definitions&&e.definitions.forEach((function(e){i(e,t)}))}var s={};function a(e,t){for(var i=0;i<e.definitions.length;i++){var s=e.definitions[i];if(s.name&&s.name.value==t)return s}}function o(e,t){var i={kind:e.kind,definitions:[a(e,t)]};e.hasOwnProperty("loc")&&(i.loc=e.loc);var o=s[t]||new Set,n=new Set,r=new Set;for(o.forEach((function(e){r.add(e)}));r.size>0;){var d=r;r=new Set,d.forEach((function(e){n.has(e)||(n.add(e),(s[e]||new Set).forEach((function(e){r.add(e)})))}))}return n.forEach((function(t){var s=a(e,t);s&&i.definitions.push(s)})),i}t.definitions.forEach((function(e){if(e.name){var t=new Set;i(e,t),s[e.name.value]=t}})),e.exports=t,e.exports.GetRoomBounds=o(t,"GetRoomBounds"),e.exports.GetRoomClassifications=o(t,"GetRoomClassifications")}}]);